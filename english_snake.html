<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英语贪吃蛇</title>
    <style>
        body {
            font-family: 'Comic Sans MS', 'Arial Rounded MT Bold', sans-serif;
            background-color: #f0f5ff;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        h1 {
            color: #ff6b6b;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            margin-bottom: 10px;
        }
        
        .word-group-selector-container {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column; 
            gap: 5px; 
            align-items: center; 
            width: 500px; 
            max-width: 100%;
        }

        #word-group-label {
            display: none; /* Hide the label */
        }

        #word-group-select {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 16px;
            background-color: white;
            cursor: pointer;
            width: 100%; 
            max-width: 300px; 
        }
        
        .game-container {
            position: relative;
            margin: 20px 0;
            display: flex;
            justify-content: center;
            width: 100%; /* Full width */
        }
        
        .canvas-wrapper {
            position: relative;
            padding: 0;
            margin: 0;
            display: block;
            border: 10px solid #a5d8ff;
            border-radius: 15px;
            background-color: #e7f5ff;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            max-width: 100%;
            box-sizing: content-box;
            overflow: hidden;
            font-size: 0;
            line-height: 0;
        }
        
        #game-board {
            display: block;
            margin: 0;
            padding: 0;
            position: relative;
            background-color: #e7f5ff;
            box-sizing: border-box;
        }
        
        .game-info {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 500px;
            max-width: 100%;
            display: flex;
            align-items: center;
            justify-content: center; /* Center the content */
            text-align: center; /* Center-align text */
        }
        
        .word-display {
            display: flex;
            align-items: center;
            text-align: center; /* Center-align text */
        }
        
        .word-icon {
            display: none; /* Hide the icon instead of removing it completely */
        }
        
        .current-word {
            font-size: 24px;
            color: #339af0;
            margin: 0;
        }
        
        .score {
            font-size: 20px;
            color: #51cf66;
            margin: 0;
        }
        
        .instructions {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 200;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .instructions-content {
            background-color: #fff9db;
            padding: 20px;
            border-radius: 10px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            position: relative;
            border-left: 5px solid #ffd43b;
        }
        
        .instructions h3 {
            color: #f08c00;
            margin-top: 0;
        }
        
        .instructions ol {
            padding-left: 20px;
            margin-bottom: 0;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .close-instructions {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #ff6b6b;
        }
        
        .instructions-button {
            background-color: #ff6b6b;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .instructions-button:hover {
            background-color: #ff8787;
        }
        
        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 107, 107, 0.9);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            display: none;
            z-index: 100;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            width: 70%;
            max-width: 400px;
        }
        
        .word-complete {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(100, 200, 100, 0.9);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            display: none;
            z-index: 100;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            width: 70%;
            max-width: 400px;
        }
        
        .continue-btn {
            background-color: white;
            color: #339af0;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .continue-btn:hover {
            background-color: #339af0;
            color: white;
        }
        
        .speech-btn {
            background-color: #ffd43b;
            color: #e67700;
            border: none;
            padding: 10px 15px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            margin-right: 10px;
            font-size: 16px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .speech-btn:hover {
            background-color: #e67700;
            color: white;
        }
        
        .speech-btn span {
            margin-left: 5px;
        }
        
        .restart-btn {
            background-color: white;
            color: #ff6b6b;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .restart-btn:hover {
            background-color: #ff8787;
            color: white;
        }
        
        .snake-segment {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: #51cf66;
            border-radius: 4px;
            z-index: 10;
        }
        
        .snake-head {
            background-color: #2b8a3e;
            border-radius: 50% 50% 5px 5px;
        }
        
        .food {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            z-index: 5;
        }
        
        .food-letter {
            pointer-events: none;
        }
        
        .celebration {
            position: absolute;
            font-size: 24px;
            color: #ff6b6b;
            font-weight: bold;
            animation: float 1.5s ease-out;
            opacity: 0;
            z-index: 20;
        }
        
        .penalty {
            position: absolute;
            font-size: 24px;
            color: #339af0;
            font-weight: bold;
            animation: float 1.5s ease-out;
            opacity: 0;
            z-index: 20;
        }
        
        @keyframes float {
            0% {
                transform: translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateY(-50px);
                opacity: 0;
            }
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 212, 59, 0.7);
            }
            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(255, 212, 59, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 212, 59, 0);
            }
        }
        
        /* Responsive styles for mobile */
        @media (max-width: 600px) {
            #game-board {
                width: 95vmin;
                height: 95vmin;
                max-width: 95%;
                aspect-ratio: 1/1;
            }
            
            .canvas-wrapper {
                width: 95vmin;
                height: 95vmin;
                max-width: 95%;
                border-width: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: hidden;
            }
            
            .game-info {
                width: 95vmin;
                max-width: 95%;
                padding: 10px;
            }
            
            .word-group-selector-container {
                width: 95vmin;
                max-width: 95%;
            }
            
            .current-word { font-size: 18px; }
            .score { font-size: 14px; }
            
            .word-complete, .game-over { width: 85%; }
            
            /* 更简洁的布局 */
            body { padding: 10px 5px; }
            h1 { font-size: 24px; margin-bottom: 5px; }
            .speed-control {
                width: calc(95vmin + 16px);
                max-width: 95%;
                font-size: 14px;
                padding: 6px 4px;
            }
            #speed-range {
                width: 173px;
            }
        }
        
        /* Mobile hint styling */
        .mobile-hint {
            background-color: #f8d7da;
            color: #721c24;
            padding: 8px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            width: 90%;
            max-width: 500px;
        }
        
        .speed-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 10px 0 0 0;
            background: #fff9db;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 16px;
            color: #f08c00;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            width: 520px;
            max-width: 100%;
            box-sizing: border-box;
        }
        .speed-control label {
            font-weight: bold;
        }
        #speed-range {
            width: 160px;
            /* 自定义滑块轨道为全灰色 */
            accent-color: #ced4da;
        }
        /* 兼容所有浏览器的灰色轨道 */
        #speed-range::-webkit-slider-runnable-track {
            background: #ced4da;
            height: 6px;
            border-radius: 3px;
        }
        #speed-range::-moz-range-track {
            background: #ced4da;
            height: 6px;
            border-radius: 3px;
        }
        #speed-range::-ms-fill-lower, #speed-range::-ms-fill-upper {
            background: #ced4da;
        }
        #speed-range::-webkit-slider-thumb {
            background: #339af0;
            border: 2px solid #fff;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            margin-top: -6px;
            cursor: pointer;
        }
        #speed-range::-moz-range-thumb {
            background: #339af0;
            border: 2px solid #fff;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        #speed-range::-ms-thumb {
            background: #339af0;
            border: 2px solid #fff;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        #speed-range:focus {
            outline: none;
        }
        #speed-range::-ms-tooltip { display: none; }
    </style>
</head>
<body>
    <h1>🐍 英语贪吃蛇 🍎</h1>
    
    <div class="word-group-selector-container">
        <label id="word-group-label" for="word-group-select">请选择需要练习拼写的单词组:</label>
        <select id="word-group-select">
            <!-- Options will be populated by JavaScript -->
        </select>
    </div>
    
    <div class="game-info">
        <div class="word-display">
            <div>
                <p class="current-word">当前单词: <span id="word-meaning">苹果</span></p>
                <p class="score">得分: <span id="score">0</span> | 连击: <span id="combo">0</span> | 最长连击: <span id="max-combo">0</span></p>
            </div>
        </div>
    </div>
    
    <div class="game-container">
        <div class="canvas-wrapper">
            <canvas id="game-board" width="500" height="500" tabindex="0"></canvas>
        </div>
        <div class="game-over" id="game-over">
            <h2>游戏结束!</h2>
            <p>你的最终得分: <span id="final-score">0</span></p>
            <button class="restart-btn" id="restart-btn">再玩一次</button>
        </div>
        <div class="word-complete" id="word-complete">
            <h2>单词完成!</h2>
            <p id="completed-word">apple [苹果]</p>
            <div>
                <button class="speech-btn" id="speak-word-btn" tabindex="0">🔊 <span>听读音</span></button>
                <button class="continue-btn" id="continue-btn" tabindex="0">继续游戏</button>
            </div>
        </div>
    </div>
    
    <!-- 速度控制条 -->
    <div class="speed-control" id="speed-control">
        <label for="speed-range" style="white-space:nowrap;">蛇速：</label>
        <input type="range" id="speed-range" min="100" max="400" step="20" value="300">
        <span id="speed-label">普通</span>
    </div>
    
    <!-- Mobile hint will be inserted here by JS -->
    
    <button class="instructions-button" id="instructions-button">📝 游戏规则说明</button>
    
    <div class="instructions" id="instructions">
        <div class="instructions-content">
            <span class="close-instructions" id="close-instructions">&times;</span>
            <h3>📝 游戏规则说明</h3>
            <ol>
                <li><strong>控制方式</strong>：在屏幕上滑动来控制小蛇移动方向
                    <ul>
                        <li>向上滑动：蛇向上移动</li>
                        <li>向下滑动：蛇向下移动</li>
                        <li>向左滑动：蛇向左移动</li>
                        <li>向右滑动：蛇向右移动</li>
                    </ul>
                </li>
                <li><strong>游戏目标</strong>：按照当前单词的字母顺序吃掉正确的字母</li>
                <li><strong>食物规则</strong>：
                    <ul>
                        <li>每次会出现3个字母食物块，其中1个是正确的</li>
                        <li>正确字母是当前单词的下一个字母</li>
                        <li>正确字母的位置和颜色每次随机变化</li>
                    </ul>
                </li>
                <li><strong>得分规则</strong>：
                    <ul>
                        <li>吃对正确字母：蛇身变长+10分</li>
                        <li>吃错字母：-5分，并更换新单词</li>
                        <li>完成整个单词：额外+50分</li>
                    </ul>
                </li>
                <li><strong>难度调节</strong>：可通过下方滑块调整蛇的速度，速度越快难度越高</li>
                <li><strong>特殊效果</strong>：
                    <ul>
                        <li>碰到墙壁会从另一边穿出</li>
                        <li>完成单词后游戏暂停，点击继续后继续游戏</li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>

    <script>
        // 游戏常量
        const GRID_SIZE = 20;
        let GAME_WIDTH = 500;
        let GAME_HEIGHT = 500; // Make it square
        let GRID_COLS = GAME_WIDTH / GRID_SIZE;
        let GRID_ROWS = GAME_HEIGHT / GRID_SIZE;
        
        const GENERIC_ICON_URL = "https://cdn-icons-png.flaticon.com/128/1005/1005037.png"; 

        // 游戏音效
        const SOUNDS = {
            correct: {
                src: 'https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3',
                volume: 0.4
            },
            wrong: {
                src: 'https://assets.mixkit.co/active_storage/sfx/2955/2955-preview.mp3',
                volume: 0.3
            },
            complete: {
                src: 'https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3',
                volume: 0.4
            },
            gameover: {
                src: 'https://assets.mixkit.co/active_storage/sfx/254/254-preview.mp3',
                volume: 0.5
            }
        };
        
        // 音效缓存
        const audioCache = {};
        let audioPlaying = false;
        
        // 播放音效函数
        function playSound(type) {
            // 检查是否支持音频
            if (!window.Audio) return;
            
            try {
                // 如果已经缓存了这个音效，则使用缓存
                if (!audioCache[type]) {
                    if (!SOUNDS[type]) return;
                    
                    const audio = new Audio(SOUNDS[type].src);
                    audio.volume = SOUNDS[type].volume || 0.5;
                    audioCache[type] = audio;
                }
                
                // 播放音效（如果正在播放，则重置并重新播放）
                const sound = audioCache[type];
                sound.currentTime = 0;
                
                // 添加结束事件
                const playPromise = sound.play();
                if (playPromise !== undefined) {
                    audioPlaying = true;
                    
                    playPromise.then(() => {
                        // 音频播放成功
                        sound.onended = () => {
                            audioPlaying = false;
                        };
                    }).catch(e => {
                        console.log('无法播放音效:', e);
                        audioPlaying = false;
                    });
                }
            } catch (e) {
                console.log('播放音效时出错:', e);
                audioPlaying = false;
            }
        }
        
        // 语音合成函数 - 确保不会与其他音效冲突
        function speakWord(word) {
            if (!word) return;
            
            // 等待当前音效播放完成
            if (audioPlaying) {
                setTimeout(() => speakWord(word), 300);
                return;
            }
            
            // 尝试使用在线API
            const utterance = encodeURIComponent(word.toLowerCase().trim());
            const audioElement = new Audio(`https://ssl.gstatic.com/dictionary/static/sounds/20200429/${utterance}--_gb_1.mp3`);
            
            audioElement.onerror = function() {
                // 如果在线API失败，尝试使用语音合成API
                if ('speechSynthesis' in window) {
                    try {
                        // 取消任何正在进行的语音
                        window.speechSynthesis.cancel();
                        
                        const speech = new SpeechSynthesisUtterance(word);
                        speech.lang = 'en-US';
                        speech.rate = 0.8;
                        speech.pitch = 1;
                        speech.volume = 0.8;
                        
                        window.speechSynthesis.speak(speech);
                    } catch (e) {
                        console.log('语音合成出错:', e);
                    }
                } else {
                    console.log('浏览器不支持语音合成');
                }
            };
            
            // 尝试播放在线音频
            audioElement.play().catch(e => {
                console.log('在线音频播放失败，尝试使用语音合成:', e);
                audioElement.onerror();
            });
        }

        const WORD_GROUPS = {
            1: [
                { word: "ten", meaning: "十", icon: GENERIC_ICON_URL }, { word: "twenty", meaning: "二十", icon: GENERIC_ICON_URL },
                { word: "thirty", meaning: "三十", icon: GENERIC_ICON_URL }, { word: "forty", meaning: "四十", icon: GENERIC_ICON_URL },
                { word: "fifty", meaning: "五十", icon: GENERIC_ICON_URL }
            ],
            2: [
                { word: "sixty", meaning: "六十", icon: GENERIC_ICON_URL }, { word: "seventy", meaning: "七十", icon: GENERIC_ICON_URL },
                { word: "eighty", meaning: "八十", icon: GENERIC_ICON_URL }, { word: "ninety", meaning: "九十", icon: GENERIC_ICON_URL },
                { word: "one hundred", meaning: "一百", icon: GENERIC_ICON_URL }
            ],
            3: [
                { word: "fifth", meaning: "第五", icon: GENERIC_ICON_URL }, { word: "third", meaning: "第三", icon: GENERIC_ICON_URL },
                { word: "fourth", meaning: "第四", icon: GENERIC_ICON_URL }, { word: "first", meaning: "第一", icon: GENERIC_ICON_URL },
                { word: "second", meaning: "第二", icon: GENERIC_ICON_URL }
            ],
            4: [
                { word: "one", meaning: "一", icon: GENERIC_ICON_URL }, { word: "two", meaning: "二", icon: GENERIC_ICON_URL },
                { word: "three", meaning: "三", icon: GENERIC_ICON_URL }, { word: "four", meaning: "四", icon: GENERIC_ICON_URL },
                { word: "five", meaning: "五", icon: GENERIC_ICON_URL }
            ],
            5: [
                { word: "six", meaning: "六", icon: GENERIC_ICON_URL }, { word: "seven", meaning: "七", icon: GENERIC_ICON_URL },
                { word: "eight", meaning: "八", icon: GENERIC_ICON_URL }, { word: "nine", meaning: "九", icon: GENERIC_ICON_URL },
                { word: "ten", meaning: "十", icon: GENERIC_ICON_URL }
            ],
            6: [
                { word: "heart", meaning: "心形", icon: GENERIC_ICON_URL }, { word: "star", meaning: "五角星", icon: GENERIC_ICON_URL },
                { word: "rectangle", meaning: "长方形", icon: GENERIC_ICON_URL }, { word: "circle", meaning: "圆形", icon: GENERIC_ICON_URL },
                { word: "square", meaning: "正方形", icon: GENERIC_ICON_URL }, { word: "triangle", meaning: "三角形", icon: GENERIC_ICON_URL }
            ],
            7: [
                { word: "butterfly", meaning: "蝴蝶", icon: GENERIC_ICON_URL }, { word: "bee", meaning: "蜜蜂", icon: GENERIC_ICON_URL },
                { word: "cricket", meaning: "蟋蟀", icon: GENERIC_ICON_URL }, { word: "ant", meaning: "蚂蚁", icon: GENERIC_ICON_URL },
                { word: "worm", meaning: "虫子", icon: GENERIC_ICON_URL }, { word: "spider", meaning: "蜘蛛", icon: GENERIC_ICON_URL }
            ],
            8: [
                { word: "insect", meaning: "昆虫", icon: GENERIC_ICON_URL }, { word: "web", meaning: "网", icon: GENERIC_ICON_URL },
                { word: "behind", meaning: "在…后面", icon: GENERIC_ICON_URL }, { word: "in front", meaning: "在…前面", icon: GENERIC_ICON_URL },
                { word: "above", meaning: "在…上面", icon: GENERIC_ICON_URL }, { word: "between", meaning: "在…中间", icon: GENERIC_ICON_URL }
            ],
            9: [
                { word: "cage", meaning: "笼子", icon: GENERIC_ICON_URL }, { word: "winter", meaning: "冬天", icon: GENERIC_ICON_URL },
                { word: "rice", meaning: "米饭", icon: GENERIC_ICON_URL }, { word: "pet", meaning: "宠物", icon: GENERIC_ICON_URL },
                { word: "keep", meaning: "养", icon: GENERIC_ICON_URL }
            ],
            10: [
                { word: "when", meaning: "什么时候", icon: GENERIC_ICON_URL }, { word: "why", meaning: "为什么", icon: GENERIC_ICON_URL },
                { word: "what", meaning: "什么", icon: GENERIC_ICON_URL }, { word: "who", meaning: "谁", icon: GENERIC_ICON_URL },
                { word: "where", meaning: "哪里", icon: GENERIC_ICON_URL }, { word: "how", meaning: "如何", icon: GENERIC_ICON_URL }
            ],
            11: [
                { word: "knee", meaning: "膝盖", icon: GENERIC_ICON_URL }, { word: "flea", meaning: "跳蚤", icon: GENERIC_ICON_URL },
                { word: "me", meaning: "我", icon: GENERIC_ICON_URL }, { word: "eat", meaning: "吃", icon: GENERIC_ICON_URL },
                { word: "she", meaning: "她", icon: GENERIC_ICON_URL }, { word: "foot", meaning: "脚", icon: GENERIC_ICON_URL }
            ],
            12: [
                { word: "recycle", meaning: "可回收", icon: GENERIC_ICON_URL }, { word: "picking", meaning: "捡起/拾", icon: GENERIC_ICON_URL },
                { word: "bin", meaning: "垃圾桶", icon: GENERIC_ICON_URL }, { word: "planting", meaning: "种植", icon: GENERIC_ICON_URL },
                { word: "watering", meaning: "浇水", icon: GENERIC_ICON_URL }
            ],
            13: [
                { word: "friend", meaning: "朋友", icon: GENERIC_ICON_URL }, { word: "aunt", meaning: "阿姨", icon: GENERIC_ICON_URL },
                { word: "uncle", meaning: "叔叔", icon: GENERIC_ICON_URL }, { word: "grandma", meaning: "奶奶", icon: GENERIC_ICON_URL },
                { word: "grandpa", meaning: "爷爷", icon: GENERIC_ICON_URL }
            ],
            14: [
                { word: "mother", meaning: "妈妈", icon: GENERIC_ICON_URL }, { word: "father", meaning: "爸爸", icon: GENERIC_ICON_URL },
                { word: "brother", meaning: "兄弟", icon: GENERIC_ICON_URL }, { word: "sister", meaning: "姐妹", icon: GENERIC_ICON_URL }
            ],
            15: [
                { word: "stem", meaning: "茎", icon: GENERIC_ICON_URL }, { word: "leaf", meaning: "叶子", icon: GENERIC_ICON_URL },
                { word: "tree", meaning: "树", icon: GENERIC_ICON_URL }, { word: "flower", meaning: "花", icon: GENERIC_ICON_URL },
                { word: "roots", meaning: "根", icon: GENERIC_ICON_URL }
            ],
            16: [
                { word: "this", meaning: "这个", icon: GENERIC_ICON_URL }, { word: "that", meaning: "那个", icon: GENERIC_ICON_URL },
                { word: "these", meaning: "这些", icon: GENERIC_ICON_URL }, { word: "those", meaning: "那些", icon: GENERIC_ICON_URL },
                { word: "they", meaning: "他们", icon: GENERIC_ICON_URL }
            ],
            17: [
                { word: "basket", meaning: "篮子", icon: GENERIC_ICON_URL }, { word: "railing", meaning: "栏杆", icon: GENERIC_ICON_URL },
                { word: "ladder", meaning: "梯子", icon: GENERIC_ICON_URL }, { word: "stairs", meaning: "楼梯", icon: GENERIC_ICON_URL },
                { word: "roof", meaning: "屋顶", icon: GENERIC_ICON_URL }, { word: "wall", meaning: "墙", icon: GENERIC_ICON_URL }
            ],
            18: [
                { word: "hall", meaning: "门厅", icon: GENERIC_ICON_URL }, { word: "bedroom", meaning: "卧室", icon: GENERIC_ICON_URL },
                { word: "kitchen", meaning: "厨房", icon: GENERIC_ICON_URL }, { word: "garden", meaning: "花园", icon: GENERIC_ICON_URL },
                { word: "bathroom", meaning: "浴室", icon: GENERIC_ICON_URL }
            ],
            19: [
                { word: "floor", meaning: "地板", icon: GENERIC_ICON_URL }, { word: "bed", meaning: "床", icon: GENERIC_ICON_URL },
                { word: "clean", meaning: "清理/干净", icon: GENERIC_ICON_URL }, { word: "table", meaning: "桌子", icon: GENERIC_ICON_URL },
                { word: "sink", meaning: "水槽", icon: GENERIC_ICON_URL }
            ],
            20: [
                { word: "warm", meaning: "温暖的", icon: GENERIC_ICON_URL }, { word: "cold", meaning: "冷的", icon: GENERIC_ICON_URL },
                { word: "cool", meaning: "凉爽的", icon: GENERIC_ICON_URL }, { word: "hot", meaning: "热的", icon: GENERIC_ICON_URL },
                { word: "keep", meaning: "保持", icon: GENERIC_ICON_URL } 
            ],
            21: [
                { word: "goose", meaning: "鹅", icon: GENERIC_ICON_URL }, { word: "moon", meaning: "月亮", icon: GENERIC_ICON_URL },
                { word: "cooker", meaning: "厨师", icon: GENERIC_ICON_URL }, { word: "good", meaning: "好的", icon: GENERIC_ICON_URL },
                { word: "look", meaning: "看", icon: GENERIC_ICON_URL }, { word: "book", meaning: "书", icon: GENERIC_ICON_URL }
            ],
            22: [
                { word: "zoo", meaning: "动物园", icon: GENERIC_ICON_URL }, { word: "big", meaning: "大的", icon: GENERIC_ICON_URL },
                { word: "strong", meaning: "强壮的", icon: GENERIC_ICON_URL }, { word: "tiny", meaning: "微小的", icon: GENERIC_ICON_URL },
                { word: "clever", meaning: "聪明的", icon: GENERIC_ICON_URL }
            ],
            23: [
                { word: "loud", meaning: "大声的", icon: GENERIC_ICON_URL }, { word: "quiet", meaning: "小声的", icon: GENERIC_ICON_URL },
                { word: "tired", meaning: "疲劳的", icon: GENERIC_ICON_URL }, { word: "happy", meaning: "快乐的", icon: GENERIC_ICON_URL },
                { word: "busy", meaning: "忙碌的", icon: GENERIC_ICON_URL }, { word: "kind", meaning: "善良的", icon: GENERIC_ICON_URL },
                { word: "friendly", meaning: "友好的", icon: GENERIC_ICON_URL }
            ],
            24: [
                { word: "count", meaning: "数", icon: GENERIC_ICON_URL }, { word: "jump", meaning: "跳", icon: GENERIC_ICON_URL },
                { word: "walk", meaning: "走", icon: GENERIC_ICON_URL }, { word: "run", meaning: "跑", icon: GENERIC_ICON_URL },
                { word: "throw", meaning: "扔", icon: GENERIC_ICON_URL }, { word: "catch", meaning: "抓住", icon: GENERIC_ICON_URL }
            ],
            25: [
                { word: "bite", meaning: "咬", icon: GENERIC_ICON_URL }, { word: "live", meaning: "住", icon: GENERIC_ICON_URL },
                { word: "move", meaning: "移动", icon: GENERIC_ICON_URL }, { word: "chase", meaning: "追", icon: GENERIC_ICON_URL },
                { word: "lift up", meaning: "举起", icon: GENERIC_ICON_URL }, { word: "shiver", meaning: "颤抖", icon: GENERIC_ICON_URL },
                { word: "scare", meaning: "吓唬", icon: GENERIC_ICON_URL }
            ],
            // Group 26 is skipped
            27: [
                { word: "read", meaning: "读", icon: GENERIC_ICON_URL }, { word: "climb", meaning: "爬", icon: GENERIC_ICON_URL },
                { word: "cut", meaning: "切", icon: GENERIC_ICON_URL }, { word: "talk", meaning: "交谈", icon: GENERIC_ICON_URL },
                { word: "swim", meaning: "游泳", icon: GENERIC_ICON_URL }, { word: "stand", meaning: "站", icon: GENERIC_ICON_URL },
                { word: "fall", meaning: "掉落", icon: GENERIC_ICON_URL }
            ],
            28: [
                { word: "come", meaning: "来", icon: GENERIC_ICON_URL }, { word: "sit", meaning: "坐", icon: GENERIC_ICON_URL },
                { word: "help", meaning: "帮助", icon: GENERIC_ICON_URL }, { word: "grow", meaning: "生长", icon: GENERIC_ICON_URL },
                { word: "call", meaning: "呼叫", icon: GENERIC_ICON_URL }, { word: "play", meaning: "玩", icon: GENERIC_ICON_URL },
                { word: "need", meaning: "需要", icon: GENERIC_ICON_URL }
            ],
            29: [
                { word: "stand", meaning: "站", icon: GENERIC_ICON_URL }, { word: "wave", meaning: "挥手", icon: GENERIC_ICON_URL }, 
                { word: "hop", meaning: "单脚跳", icon: GENERIC_ICON_URL }, { word: "wiggle", meaning: "扭动", icon: GENERIC_ICON_URL },
                { word: "nod", meaning: "点头", icon: GENERIC_ICON_URL }, { word: "touch", meaning: "触摸", icon: GENERIC_ICON_URL }
            ],
            30: [
                { word: "clock", meaning: "钟", icon: GENERIC_ICON_URL }, { word: "calendar", meaning: "日历", icon: GENERIC_ICON_URL },
                { word: "tablet", meaning: "平板", icon: GENERIC_ICON_URL }, { word: "book", meaning: "书", icon: GENERIC_ICON_URL }, 
                { word: "map", meaning: "地图", icon: GENERIC_ICON_URL }
            ],
            31: [
                { word: "ball", meaning: "球", icon: GENERIC_ICON_URL }, { word: "skipping", meaning: "跳绳", icon: GENERIC_ICON_URL },
                { word: "phone", meaning: "手机", icon: GENERIC_ICON_URL }, { word: "pencil", meaning: "铅笔", icon: GENERIC_ICON_URL },
                { word: "hat", meaning: "帽子", icon: GENERIC_ICON_URL }, { word: "key", meaning: "钥匙", icon: GENERIC_ICON_URL }
            ],
            32: [
                { word: "sunglasses", meaning: "太阳镜", icon: GENERIC_ICON_URL }, { word: "outside", meaning: "外面", icon: GENERIC_ICON_URL },
                { word: "window cleaner", meaning: "窗户清洁工", icon: GENERIC_ICON_URL }, { word: "police officer", meaning: "警察", icon: GENERIC_ICON_URL },
                { word: "reporter", meaning: "记者", icon: GENERIC_ICON_URL }
            ],
            33: [
                { word: "helmet", meaning: "头盔", icon: GENERIC_ICON_URL }, { word: "gloves", meaning: "手套", icon: GENERIC_ICON_URL },
                { word: "mask", meaning: "面具", icon: GENERIC_ICON_URL }, { word: "nurse", meaning: "护士", icon: GENERIC_ICON_URL },
                { word: "boot", meaning: "靴子", icon: GENERIC_ICON_URL }, { word: "driver", meaning: "司机", icon: GENERIC_ICON_URL },
                { word: "jacket", meaning: "夹克", icon: GENERIC_ICON_URL }
            ],
            34: [
                { word: "apple", meaning: "苹果", icon: GENERIC_ICON_URL }, { word: "orange", meaning: "橘子", icon: GENERIC_ICON_URL },
                { word: "carrots", meaning: "胡萝卜", icon: GENERIC_ICON_URL }, { word: "soup", meaning: "汤", icon: GENERIC_ICON_URL },
                { word: "milk", meaning: "牛奶", icon: GENERIC_ICON_URL }, { word: "yogurt", meaning: "酸奶", icon: GENERIC_ICON_URL }
            ],
            35: [
                { word: "shadow", meaning: "影子", icon: GENERIC_ICON_URL }, { word: "high", meaning: "高的", icon: GENERIC_ICON_URL },
                { word: "low", meaning: "低的", icon: GENERIC_ICON_URL }, { word: "some", meaning: "一些", icon: GENERIC_ICON_URL },
                { word: "most", meaning: "大部分", icon: GENERIC_ICON_URL }, { word: "all", meaning: "所有", icon: GENERIC_ICON_URL },
                { word: "sky", meaning: "天空", icon: GENERIC_ICON_URL }
            ],
            36: [
                { word: "moon", meaning: "月亮", icon: GENERIC_ICON_URL }, { word: "long", meaning: "长的", icon: GENERIC_ICON_URL }, 
                { word: "short", meaning: "短的", icon: GENERIC_ICON_URL }, { word: "sun", meaning: "太阳", icon: GENERIC_ICON_URL },
                { word: "star", meaning: "星星", icon: GENERIC_ICON_URL }, { word: "earth", meaning: "地球", icon: GENERIC_ICON_URL },
                { word: "planet", meaning: "星球", icon: GENERIC_ICON_URL }
            ]
        };
        
        // 游戏变量
        let snake = [];
        let direction = "RIGHT";
        let nextDirection = "RIGHT";
        let food = [];
        let currentWordList = []; // Holds words from the selected group
        let currentWord = null;
        let nextLetterIndex = 0;
        let score = 0;
        let combo = 0;
        let maxCombo = 0;
        let gameSpeed = 200;
        let gameLoop;
        let gameOver = false;
        let gamePaused = false;
        let isWordCompletePopupActive = false; // New flag
        
        // DOM元素
        const canvas = document.getElementById("game-board");
        const ctx = canvas.getContext("2d");
        const wordMeaningEl = document.getElementById("word-meaning");
        const wordIconEl = document.getElementById("word-icon");
        const scoreEl = document.getElementById("score");
        const comboEl = document.getElementById("combo");
        const maxComboEl = document.getElementById("max-combo");
        const gameOverEl = document.getElementById("game-over");
        const wordCompleteEl = document.getElementById("word-complete");
        const completedWordEl = document.getElementById("completed-word");
        const finalScoreEl = document.getElementById("final-score");
        const restartBtn = document.getElementById("restart-btn");
        const continueBtn = document.getElementById("continue-btn");
        const instructionsButton = document.getElementById("instructions-button");
        const instructionsElement = document.getElementById("instructions");
        const closeInstructions = document.getElementById("close-instructions");
        const wordGroupSelect = document.getElementById("word-group-select");
        
        // 检测是否为移动设备，添加相应提示
        const isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        if (isMobileDevice) {
            // 添加移动设备操作提示
            const mobileHint = document.createElement("div");
            mobileHint.className = "mobile-hint";
            mobileHint.textContent = "在游戏区域滑动可控制蛇的方向";
            
            // 插入到游戏区域下面，游戏规则说明按钮上面
            const instructionsButton = document.getElementById("instructions-button");
            instructionsButton.parentNode.insertBefore(mobileHint, instructionsButton);
        }
        
        // 初始化游戏
        function initGame() {
            adjustGameSize();
            
            snake = [
                { x: 5, y: 10 },
                { x: 4, y: 10 },
                { x: 3, y: 10 }
            ];
            direction = "RIGHT";
            nextDirection = "RIGHT";
            score = 0;
            combo = 0;
            maxCombo = 0;
            gameOver = false;
            gamePaused = false;
            isWordCompletePopupActive = false;
            gameOverEl.style.display = "none";
            wordCompleteEl.style.display = "none";
            
            selectNewWord();
            generateFood();
            updateUI();
            
            if (gameLoop) clearInterval(gameLoop);
            gameLoop = setInterval(gameStep, gameSpeed);
            canvas.focus();
        }
        
        // 响应式调整游戏大小
        function adjustGameSize() {
            const isMobile = window.innerWidth <= 600;
            
            // 设置基础游戏尺寸
            if (isMobile) {
                let screenWidth = Math.min(window.innerWidth * 0.9, 350);
                GAME_WIDTH = Math.floor(screenWidth / GRID_SIZE) * GRID_SIZE;
                GAME_HEIGHT = GAME_WIDTH; // 正方形
            } else {
                GAME_WIDTH = 500;
                GAME_HEIGHT = 500;
            }
            
            // 计算网格单元数量
            GRID_COLS = Math.floor(GAME_WIDTH / GRID_SIZE);
            GRID_ROWS = Math.floor(GAME_HEIGHT / GRID_SIZE);
            GAME_WIDTH = GRID_COLS * GRID_SIZE; // 确保尺寸是网格单元的精确倍数
            GAME_HEIGHT = GRID_ROWS * GRID_SIZE;
            
            // 设置边框和Canvas尺寸
            const wrapper = document.querySelector('.canvas-wrapper');
            if (wrapper) {
                const borderWidth = parseInt(getComputedStyle(wrapper).borderWidth) || (isMobile ? 8 : 10);
                
                if (isMobile) {
                    // 移动设备: 计算边框内可用空间
                    const availableWidth = GAME_WIDTH - (borderWidth * 2);
                    const gridAlignedWidth = Math.floor(availableWidth / GRID_SIZE) * GRID_SIZE;
                    
                    // 更新Canvas尺寸和网格
                    canvas.width = gridAlignedWidth;
                    canvas.height = gridAlignedWidth;
                    canvas.style.width = gridAlignedWidth + 'px';
                    canvas.style.height = gridAlignedWidth + 'px';
                    GRID_COLS = gridAlignedWidth / GRID_SIZE;
                    GRID_ROWS = gridAlignedWidth / GRID_SIZE;
                    
                    // 设置边框容器尺寸
                    wrapper.style.width = GAME_WIDTH + 'px';
                    wrapper.style.height = GAME_HEIGHT + 'px';
                } else {
                    // 桌面设备: 常规设置并修复边框对齐
                    canvas.width = GAME_WIDTH;
                    canvas.height = GAME_HEIGHT;
                    canvas.style.width = GAME_WIDTH + 'px';
                    canvas.style.height = GAME_HEIGHT + 'px';
                    wrapper.style.width = (GAME_WIDTH - 1) + 'px'; // 修复右侧边框对齐
                    wrapper.style.height = GAME_HEIGHT + 'px';
                }
                wrapper.style.boxSizing = 'content-box';
            }
            
            // 确保蛇在网格范围内
            for (let i = 0; i < snake.length; i++) {
                snake[i].x = Math.min(snake[i].x, GRID_COLS - 1);
                snake[i].y = Math.min(snake[i].y, GRID_ROWS - 1);
            }
            
            generateFood();
            drawGame();
        }
        
        // 监听窗口大小变化
        window.addEventListener('resize', () => {
            if (!gameOver && !gamePaused) {
                // 暂停游戏，调整大小后继续
                clearInterval(gameLoop);
                adjustGameSize();
                drawGame(); // 重新绘制
                gameLoop = setInterval(gameStep, gameSpeed);
            } else {
                adjustGameSize();
                drawGame(); // 重新绘制
            }
        });
        
        // 更换单词组但保持蛇的状态
        function changeWordGroup(newGroupKey) {
            // Only change the word list but keep snake state
            if (newGroupKey === "all") {
                createCombinedWordList();
            } else if (WORD_GROUPS[newGroupKey]) {
                currentWordList = WORD_GROUPS[newGroupKey];
            }
            
            // Unpause if paused from word completion
            if (gamePaused && isWordCompletePopupActive) {
                gamePaused = false;
                isWordCompletePopupActive = false;
            }
            
            // Clear any popups
            gameOverEl.style.display = "none";
            wordCompleteEl.style.display = "none";
            
            // Get a new word and food
            selectNewWord();
            generateFood();
            updateUI();
            
            // Ensure the game is running
            if (!gameLoop || gameOver) {
                if (gameLoop) clearInterval(gameLoop);
                gameLoop = setInterval(gameStep, gameSpeed);
            }
            
            canvas.focus();
        }
        
        // 选择新单词
        function selectNewWord() {
            if (!currentWordList || currentWordList.length === 0) {
                const firstGroupKey = Object.keys(WORD_GROUPS)[0];
                if (WORD_GROUPS[firstGroupKey]) {
                    currentWordList = WORD_GROUPS[firstGroupKey];
                    if (wordGroupSelect.value !== firstGroupKey) { 
                        wordGroupSelect.value = firstGroupKey;
                    }
                } else {
                    alert("错误：单词列表为空！");
                    gameOver = true;
                    return;
                }
            }
            currentWord = currentWordList[Math.floor(Math.random() * currentWordList.length)];
            nextLetterIndex = 0;
            updateUI();
        }
        
        // 生成食物（现在每次生成3个字母，其中1个是正确的）
        function generateFood() {
            food = [];
            
            if (!currentWord || typeof currentWord.word !== 'string' || nextLetterIndex >= currentWord.word.length) {
                return;
            }
            
            // 当前应吃的字母
            const currentLetter = currentWord.word[nextLetterIndex];
            
            // 随机选择2个错误字母
            let wrongLetters = [];
            const otherLettersInWord = currentWord.word.split('').filter((_, i) => i !== nextLetterIndex);
            
            if (otherLettersInWord.length > 0) {
                wrongLetters.push(otherLettersInWord[Math.floor(Math.random() * otherLettersInWord.length)]);
            }
            
            const alphabet = 'abcdefghijklmnopqrstuvwxyz';
            while (wrongLetters.length < 2) {
                const randomLetter = alphabet[Math.floor(Math.random() * alphabet.length)];
                if (randomLetter !== currentLetter && !wrongLetters.includes(randomLetter) && currentWord.word.indexOf(randomLetter) === -1) {
                    wrongLetters.push(randomLetter);
                }
            }
            
            const allLetters = [currentLetter, ...wrongLetters].sort(() => Math.random() - 0.5);
            
            for (let i = 0; i < 3; i++) {
                let foodItem;
                let attempts = 0;
                do {
                    foodItem = {
                        x: Math.floor(Math.random() * GRID_COLS),
                        y: Math.floor(Math.random() * GRID_ROWS),
                        letter: allLetters[i],
                        type: allLetters[i] === currentLetter ? "correct" : "wrong",
                        color: getRandomFoodColor()
                    };
                    attempts++;
                } while (
                    (isPositionOnSnake(foodItem.x, foodItem.y) || 
                    food.some(f => f.x === foodItem.x && f.y === foodItem.y)) && attempts < 100
                );
                if (attempts < 100) {
                    food.push(foodItem);
                }
            }
        }
        
        // 获取随机食物颜色（正确食物用红色系，错误食物随机颜色）
        function getRandomFoodColor() {
            const colors = [
                '#ff6b6b', '#ff8787', '#ff5252', // 红色系
                '#fcc419', '#ffd43b', '#fab005',   // 黄色系
                '#51cf66', '#40c057', '#37b24d',   // 绿色系
                '#339af0', '#228be6', '#1c7ed6',   // 蓝色系
                '#ae3ec9', '#9c36b5', '#862e9c'    // 紫色系
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // 检查位置是否在蛇身上
        function isPositionOnSnake(x, y) {
            return snake.some(segment => segment.x === x && segment.y === y);
        }
        
        // 游戏主循环
        function gameStep() {
            if (gameOver || gamePaused) return;
            
            direction = nextDirection;
            
            // 移动蛇
            const head = { ...snake[0] };
            
            switch (direction) {
                case "UP": head.y -= 1; break;
                case "DOWN": head.y += 1; break;
                case "LEFT": head.x -= 1; break;
                case "RIGHT": head.x += 1; break;
            }
            
            // 穿墙处理
            if (head.x < 0) head.x = GRID_COLS - 1;
            if (head.x >= GRID_COLS) head.x = 0;
            if (head.y < 0) head.y = GRID_ROWS - 1;
            if (head.y >= GRID_ROWS) head.y = 0;
            
            // 检查自身碰撞
            if (snake.some(segment => segment.x === head.x && segment.y === head.y)) {
                endGame();
                return;
            }
            
            snake.unshift(head);
            
            // 检查是否吃到食物
            let eatenFoodIndex = -1;
            for (let i = 0; i < food.length; i++) {
                if (food[i].x === head.x && food[i].y === head.y) {
                    eatenFoodIndex = i;
                    break;
                }
            }
            
            if (eatenFoodIndex !== -1) {
                const eatenFood = food[eatenFoodIndex];
                
                if (eatenFood.type === "correct") {
                    handleCorrectFood();
                } else {
                    handleWrongFood();
                }
                
                generateFood();
            } else {
                snake.pop();
            }
            
            drawGame();
        }
        
        // 处理吃对食物
        function handleCorrectFood() {
            const correctFoodItem = food.find(f => f.x === snake[0].x && f.y === snake[0].y && f.type === "correct");
            if (correctFoodItem) {
                showCelebration("+10", correctFoodItem);
            }
            
            score += 10;
            combo += 1;
            if (combo > maxCombo) {
                maxCombo = combo;
            }
            
            nextLetterIndex += 1;
            
            // 播放正确音效
            playSound('correct');
            
            if (currentWord && nextLetterIndex >= currentWord.word.length) {
                score += 50;
                showWordComplete();
            }
            updateUI();
        }
        
        // 显示单词完成提示
        function showWordComplete() {
            gamePaused = true;
            isWordCompletePopupActive = true;
            completedWordEl.textContent = `${currentWord.word} [${currentWord.meaning}]`;
            wordCompleteEl.style.display = "block";
            
            // 播放完成音效
            playSound('complete');
            
            // 延迟后尝试发音，确保它不与完成音效冲突
            safelySpeak();
            
            // 聚焦继续按钮方便键盘操作
            setTimeout(() => {
                continueBtn.focus();
            }, 100);
        }
        
        // 继续游戏
        function continueGame() {
            gamePaused = false;
            isWordCompletePopupActive = false; // Reset flag
            wordCompleteEl.style.display = "none";
            selectNewWord(); 
            generateFood();
            updateUI();
            canvas.focus(); // Ensure canvas gets focus after continuing
        }
        
        // 处理吃错食物
        function handleWrongFood() {
            const wrongFoodItem = food.find(f => f.x === snake[0].x && f.y === snake[0].y && f.type === "wrong");
            if (wrongFoodItem) {
                showPenalty("-5", wrongFoodItem);
            }

            score = Math.max(0, score - 5);
            
            // 不再缩短蛇的长度
            combo = 0;
            selectNewWord();
            updateUI();
            
            // 播放错误音效
            playSound('wrong');
        }
        
        // 显示庆祝效果
        function showCelebration(text, position) {
            const celebration = document.createElement("div");
            celebration.className = "celebration";
            celebration.textContent = text;
            // Ensure position is valid and apply styles
            if (position && typeof position.x === 'number' && typeof position.y === 'number') {
                celebration.style.left = `${position.x * GRID_SIZE}px`;
                celebration.style.top = `${position.y * GRID_SIZE}px`;
            }
            document.querySelector(".game-container").appendChild(celebration);
            
            setTimeout(() => {
                celebration.remove();
            }, 1500);
        }
        
        // 显示惩罚效果
        function showPenalty(text, position) {
            const penalty = document.createElement("div");
            penalty.className = "penalty";
            penalty.textContent = text;
            if (position && typeof position.x === 'number' && typeof position.y === 'number') {
                penalty.style.left = `${position.x * GRID_SIZE}px`;
                penalty.style.top = `${position.y * GRID_SIZE}px`;
            }
            document.querySelector(".game-container").appendChild(penalty);
            
            setTimeout(() => {
                penalty.remove();
            }, 1500);
        }
        
        // 结束游戏
        function endGame() {
            gameOver = true;
            clearInterval(gameLoop);
            finalScoreEl.textContent = score;
            gameOverEl.style.display = "block";
            
            // 播放游戏结束音效
            playSound('gameover');
        }
        
        // 绘制游戏
        function drawGame() {
            ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            ctx.fillStyle = "#e7f5ff";
            ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            
            // 绘制蛇
            snake.forEach((segment, index) => {
                const x = segment.x * GRID_SIZE;
                const y = segment.y * GRID_SIZE;
                
                if (index === 0) {
                    // 蛇头
                    ctx.fillStyle = "#2b8a3e";
                    ctx.beginPath();
                    ctx.roundRect(x, y, GRID_SIZE, GRID_SIZE, [10, 10, 5, 5]);
                    ctx.fill();
                } else {
                    // 蛇身
                    ctx.fillStyle = index % 2 === 0 ? "#51cf66" : "#40c057";
                    ctx.fillRect(x, y, GRID_SIZE, GRID_SIZE);
                    ctx.fillStyle = "#d3f9d8";
                    ctx.fillRect(x + 4, y + 4, GRID_SIZE - 8, GRID_SIZE - 8);
                }
            });
            
            // 绘制食物
            food.forEach(f => {
                const x = f.x * GRID_SIZE;
                const y = f.y * GRID_SIZE;
                ctx.fillStyle = f.color;
                ctx.beginPath();
                ctx.arc(x + GRID_SIZE / 2, y + GRID_SIZE / 2, GRID_SIZE / 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = f.type === "correct" ? "#ff8787" : "#ffd43b";
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(x + GRID_SIZE / 2, y + GRID_SIZE / 2, GRID_SIZE / 2 + 2, 0, Math.PI * 2);
                ctx.stroke();
                ctx.fillStyle = "white";
                ctx.font = "bold 12px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(f.letter.toUpperCase(), x + GRID_SIZE / 2, y + GRID_SIZE / 2);
            });
        }
        
        // 更新UI
        function updateUI() {
            if (currentWord) { // Check if currentWord is not null
                wordMeaningEl.textContent = currentWord.meaning; // This should be Chinese meaning now
            } else {
                // Handle case where currentWord might be temporarily null (e.g. during init before first selection)
                wordMeaningEl.textContent = "加载中...";
            }
            scoreEl.textContent = score;
            comboEl.textContent = combo;
            maxComboEl.textContent = maxCombo;
        }
        
        // 键盘控制
        document.addEventListener("keydown", e => {
            if (gamePaused && !gameOver && isWordCompletePopupActive) {
                // Handle Enter key for word complete popup only
                if (e.key === "Enter") {
                    continueGame();
                    return; // Prevent further processing
                }
                return; // Don't process other keys when paused
            }
            
            if (gameOver) {
                // Handle keys for game over state
                if (e.key === "Enter" || e.key === " ") {
                    initGame();
                }
                return; // Don't process other keys when game over
            }
            
            // Normal game controls when neither paused nor game over
            switch (e.key) {
                case "ArrowUp":
                    if (direction !== "DOWN") nextDirection = "UP";
                    break;
                case "ArrowDown":
                    if (direction !== "UP") nextDirection = "DOWN";
                    break;
                case "ArrowLeft":
                    if (direction !== "RIGHT") nextDirection = "LEFT";
                    break;
                case "ArrowRight":
                    if (direction !== "LEFT") nextDirection = "RIGHT";
                    break;
            }
        });
        
        // Add a direct Enter key handler to the continue button
        continueBtn.addEventListener("keydown", function(e) {
            if (e.key === "Enter") {
                e.preventDefault(); // Prevent default behavior
                continueGame();
            }
        });
        
        // 重新开始按钮
        restartBtn.addEventListener("click", initGame);
        
        // 继续游戏按钮
        continueBtn.addEventListener("click", continueGame);
        
        // 发音按钮
        const speakWordBtn = document.getElementById("speak-word-btn");
        speakWordBtn.addEventListener("click", () => {
            if (currentWord) {
                // 重置按钮动画
                speakWordBtn.style.animation = 'none';
                void speakWordBtn.offsetWidth; // 触发重绘
                speakWordBtn.style.animation = null;
                
                // 不再播放额外的音效，直接读单词
                speakWord(currentWord.word);
            }
        });
        
        // 在完成时发音可能会在移动设备上失败，所以需要一个可靠的方法
        function safelySpeak() {
            // 突出显示听读音按钮
            setTimeout(() => {
                const speakBtn = document.getElementById("speak-word-btn");
                if (speakBtn) {
                    speakBtn.style.animation = "pulse 1.5s infinite";
                }
            }, 200);
            
            if (!isMobileDevice) {
                // 桌面设备上尝试自动发音，但延迟足够时间让完成音效先播放完
                setTimeout(() => {
                    if (currentWord && !audioPlaying) {
                        speakWord(currentWord.word);
                    } else if (currentWord) {
                        // 如果音效还在播放，再延迟一点
                        setTimeout(() => speakWord(currentWord.word), 500);
                    }
                }, 1000);
            }
        }
        
        // 点击显示指引按钮
        instructionsButton.addEventListener("click", () => {
            instructionsElement.style.display = "flex";
        });
        
        closeInstructions.addEventListener("click", () => {
            instructionsElement.style.display = "none";
        });
        
        // 点击遮罩层关闭指引
        instructionsElement.addEventListener("click", (e) => {
            if (e.target === instructionsElement) {
                instructionsElement.style.display = "none";
            }
        });
        
        // Populate word group selector
        function populateWordGroupSelector() {
            const allOption = document.createElement("option");
            allOption.value = "all";
            allOption.textContent = "请选择需要练习拼写的单词组";
            wordGroupSelect.appendChild(allOption);
            
            for (const groupKey in WORD_GROUPS) {
                if (Object.hasOwnProperty.call(WORD_GROUPS, groupKey)) {
                    const option = document.createElement("option");
                    option.value = groupKey;
                    option.textContent = `第 ${groupKey} 组`;
                    wordGroupSelect.appendChild(option);
                }
            }
            
            wordGroupSelect.value = "all";
        }

        // Event listener for word group selection
        wordGroupSelect.addEventListener("change", (event) => {
            const selectedGroupKey = event.target.value;
            
            // If the game is over, fully reset with initGame
            // Otherwise just change the word group while preserving snake state
            if (gameOver) {
                if (selectedGroupKey === "all") {
                    // Create a combined word list from all groups
                    createCombinedWordList();
                    initGame();
                } else if (WORD_GROUPS[selectedGroupKey]) {
                    currentWordList = WORD_GROUPS[selectedGroupKey];
                    initGame(); // Complete reset when game is over
                }
            } else {
                if (selectedGroupKey === "all") {
                    createCombinedWordList();
                    changeWordGroup(selectedGroupKey);
                } else {
                    changeWordGroup(selectedGroupKey); // Preserve snake when game is ongoing
                }
            }
        });
        
        // Function to create a combined word list from all groups
        function createCombinedWordList() {
            currentWordList = [];
            for (const groupKey in WORD_GROUPS) {
                if (Object.hasOwnProperty.call(WORD_GROUPS, groupKey)) {
                    currentWordList = currentWordList.concat(WORD_GROUPS[groupKey]);
                }
            }
        }
        
        // 触摸控制（移动设备）
        let touchStartX = 0;
        let touchStartY = 0;
        
        canvas.addEventListener("touchstart", e => {
            if (gamePaused || gameOver) return;
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            e.preventDefault(); // Prevent scrolling when touching the canvas
        }, { passive: false });
        
        canvas.addEventListener("touchend", e => {
            if (gamePaused || gameOver) return;
            
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            
            // Minimum distance for swipe to be registered
            const minSwipeDistance = 30;
            
            if (Math.abs(deltaX) < minSwipeDistance && Math.abs(deltaY) < minSwipeDistance) {
                return; // Not enough movement to be considered a swipe
            }
            
            // Check if horizontal swipe is more significant than vertical
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                // Horizontal swipe
                if (deltaX > 0) {
                    // Swipe right
                    if (direction !== "LEFT") nextDirection = "RIGHT";
                } else {
                    // Swipe left
                    if (direction !== "RIGHT") nextDirection = "LEFT";
                }
            } else {
                // Vertical swipe
                if (deltaY > 0) {
                    // Swipe down
                    if (direction !== "UP") nextDirection = "DOWN";
                } else {
                    // Swipe up
                    if (direction !== "DOWN") nextDirection = "UP";
                }
            }
            
            e.preventDefault();
        }, { passive: false });
        
        // Prevent page scrolling when touching the canvas
        canvas.addEventListener("touchmove", e => {
            if (gamePaused || gameOver) return;
            e.preventDefault();
        }, { passive: false });
        
        // 速度控制逻辑
        const speedRange = document.getElementById('speed-range');
        const speedLabel = document.getElementById('speed-label');
        const speedMap = {
            100: '龟速',
            150: '很慢',
            200: '较慢',
            250: '普通',
            300: '较快',
            350: '很快',
            400: '极快'
        };
        function updateSpeedLabel(val) {
            // 取最近的速度标签
            let closest = 100;
            for (let v of Object.keys(speedMap)) {
                if (Math.abs(val - v) < Math.abs(val - closest)) closest = v;
            }
            speedLabel.textContent = speedMap[closest] || val + 'ms';
        }
        speedRange.addEventListener('input', function() {
            // 反转：左最慢右最快
            gameSpeed = 500 - Number(speedRange.value);
            updateSpeedLabel(speedRange.value);
            if (gameLoop) {
                clearInterval(gameLoop);
                gameLoop = setInterval(gameStep, gameSpeed);
            }
        });
        // 初始化速度标签和实际速度
        updateSpeedLabel(speedRange.value);
        gameSpeed = 500 - Number(speedRange.value);
        
        // 开始游戏
        populateWordGroupSelector(); 
        const initialGroupKey = wordGroupSelect.value || "all";
        if (initialGroupKey === "all") {
            createCombinedWordList();
        } else if (WORD_GROUPS[initialGroupKey]) {
            currentWordList = WORD_GROUPS[initialGroupKey];
        } else if (Object.keys(WORD_GROUPS).length > 0) { 
            currentWordList = WORD_GROUPS[Object.keys(WORD_GROUPS)[0]];
            wordGroupSelect.value = Object.keys(WORD_GROUPS)[0]; 
        }
        initGame(); 
        canvas.focus(); // Initial focus on game start
    </script>
</body>
</html>