<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±è¯­è´ªåƒè›‡</title>
    <style>
        body {
            font-family: 'Comic Sans MS', 'Arial Rounded MT Bold', sans-serif;
            background-color: #f0f5ff;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        h1 {
            color: #ff6b6b;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            margin-bottom: 10px;
        }
        
        .word-group-selector-container {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column; 
            gap: 5px; 
            align-items: center; 
            width: 500px; 
            max-width: 100%;
        }

        #word-group-label {
            display: none; /* Hide the label */
        }

        #word-group-select {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 16px;
            background-color: white;
            cursor: pointer;
            width: 100%; 
            max-width: 300px; 
        }
        
        .game-container {
            position: relative;
            margin: 20px 0;
            display: flex;
            justify-content: center;
            width: 100%; /* Full width */
        }
        
        .canvas-wrapper {
            position: relative;
            padding: 0;
            margin: 0;
            display: block;
            border: 10px solid #a5d8ff;
            border-radius: 15px;
            background-color: #e7f5ff;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            max-width: 100%;
            box-sizing: content-box;
            overflow: hidden;
            font-size: 0;
            line-height: 0;
        }
        
        #game-board {
            display: block;
            margin: 0;
            padding: 0;
            position: relative;
            background-color: #e7f5ff;
            box-sizing: border-box;
        }
        
        .game-info {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 500px;
            max-width: 100%;
            display: flex;
            align-items: center;
            justify-content: center; /* Center the content */
            text-align: center; /* Center-align text */
        }
        
        .word-display {
            display: flex;
            align-items: center;
            text-align: center; /* Center-align text */
        }
        
        .word-icon {
            display: none; /* Hide the icon instead of removing it completely */
        }
        
        .current-word {
            font-size: 24px;
            color: #339af0;
            margin: 0;
        }
        
        .score {
            font-size: 20px;
            color: #51cf66;
            margin: 0;
        }
        
        .instructions {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 200;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .instructions-content {
            background-color: #fff9db;
            padding: 20px;
            border-radius: 10px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            position: relative;
            border-left: 5px solid #ffd43b;
        }
        
        .instructions h3 {
            color: #f08c00;
            margin-top: 0;
        }
        
        .instructions ol {
            padding-left: 20px;
            margin-bottom: 0;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .close-instructions {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #ff6b6b;
        }
        
        .instructions-button {
            background-color: #ff6b6b;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .instructions-button:hover {
            background-color: #ff8787;
        }
        
        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 107, 107, 0.9);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            display: none;
            z-index: 100;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            width: 70%;
            max-width: 400px;
        }
        
        .word-complete {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(100, 200, 100, 0.9);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            display: none;
            z-index: 100;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            width: 70%;
            max-width: 400px;
        }
        
        .continue-btn {
            background-color: white;
            color: #339af0;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .continue-btn:hover {
            background-color: #339af0;
            color: white;
        }
        
        .speech-btn {
            background-color: #ffd43b;
            color: #e67700;
            border: none;
            padding: 10px 15px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            margin-right: 10px;
            font-size: 16px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .speech-btn:hover {
            background-color: #e67700;
            color: white;
        }
        
        .speech-btn span {
            margin-left: 5px;
        }
        
        .restart-btn {
            background-color: white;
            color: #ff6b6b;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .restart-btn:hover {
            background-color: #ff8787;
            color: white;
        }
        
        .snake-segment {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: #51cf66;
            border-radius: 4px;
            z-index: 10;
        }
        
        .snake-head {
            background-color: #2b8a3e;
            border-radius: 50% 50% 5px 5px;
        }
        
        .food {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            z-index: 5;
        }
        
        .food-letter {
            pointer-events: none;
        }
        
        .celebration {
            position: absolute;
            font-size: 24px;
            color: #ff6b6b;
            font-weight: bold;
            animation: float 1.5s ease-out;
            opacity: 0;
            z-index: 20;
        }
        
        .penalty {
            position: absolute;
            font-size: 24px;
            color: #339af0;
            font-weight: bold;
            animation: float 1.5s ease-out;
            opacity: 0;
            z-index: 20;
        }
        
        @keyframes float {
            0% {
                transform: translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateY(-50px);
                opacity: 0;
            }
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 212, 59, 0.7);
            }
            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(255, 212, 59, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 212, 59, 0);
            }
        }
        
        /* Responsive styles for mobile */
        @media (max-width: 600px) {
            #game-board {
                width: 95vmin;
                height: 95vmin;
                max-width: 95%;
                aspect-ratio: 1/1;
            }
            
            .canvas-wrapper {
                width: 95vmin;
                height: 95vmin;
                max-width: 95%;
                border-width: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: hidden;
            }
            
            .game-info {
                width: 95vmin;
                max-width: 95%;
                padding: 10px;
            }
            
            .word-group-selector-container {
                width: 95vmin;
                max-width: 95%;
            }
            
            .current-word { font-size: 18px; }
            .score { font-size: 14px; }
            
            .word-complete, .game-over { width: 85%; }
            
            /* æ›´ç®€æ´çš„å¸ƒå±€ */
            body { padding: 10px 5px; }
            h1 { font-size: 24px; margin-bottom: 5px; }
            .speed-control {
                width: calc(95vmin + 16px);
                max-width: 95%;
                font-size: 14px;
                padding: 6px 4px;
            }
            #speed-range {
                width: 173px;
            }
        }
        
        /* Mobile hint styling */
        .mobile-hint {
            background-color: #f8d7da;
            color: #721c24;
            padding: 8px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            width: 90%;
            max-width: 500px;
        }
        
        .speed-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 10px 0 0 0;
            background: #fff9db;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 16px;
            color: #f08c00;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            width: 520px;
            max-width: 100%;
            box-sizing: border-box;
        }
        .speed-control label {
            font-weight: bold;
        }
        #speed-range {
            width: 160px;
            /* è‡ªå®šä¹‰æ»‘å—è½¨é“ä¸ºå…¨ç°è‰² */
            accent-color: #ced4da;
        }
        /* å…¼å®¹æ‰€æœ‰æµè§ˆå™¨çš„ç°è‰²è½¨é“ */
        #speed-range::-webkit-slider-runnable-track {
            background: #ced4da;
            height: 6px;
            border-radius: 3px;
        }
        #speed-range::-moz-range-track {
            background: #ced4da;
            height: 6px;
            border-radius: 3px;
        }
        #speed-range::-ms-fill-lower, #speed-range::-ms-fill-upper {
            background: #ced4da;
        }
        #speed-range::-webkit-slider-thumb {
            background: #339af0;
            border: 2px solid #fff;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            margin-top: -6px;
            cursor: pointer;
        }
        #speed-range::-moz-range-thumb {
            background: #339af0;
            border: 2px solid #fff;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        #speed-range::-ms-thumb {
            background: #339af0;
            border: 2px solid #fff;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        #speed-range:focus {
            outline: none;
        }
        #speed-range::-ms-tooltip { display: none; }
    </style>
</head>
<body>
    <h1>ğŸ è‹±è¯­è´ªåƒè›‡ ğŸ</h1>
    
    <div class="word-group-selector-container">
        <label id="word-group-label" for="word-group-select">è¯·é€‰æ‹©éœ€è¦ç»ƒä¹ æ‹¼å†™çš„å•è¯ç»„:</label>
        <select id="word-group-select">
            <!-- Options will be populated by JavaScript -->
        </select>
    </div>
    
    <div class="game-info">
        <div class="word-display">
            <div>
                <p class="current-word">å½“å‰å•è¯: <span id="word-meaning">è‹¹æœ</span></p>
                <p class="score">å¾—åˆ†: <span id="score">0</span> | è¿å‡»: <span id="combo">0</span> | æœ€é•¿è¿å‡»: <span id="max-combo">0</span></p>
            </div>
        </div>
    </div>
    
    <div class="game-container">
        <div class="canvas-wrapper">
            <canvas id="game-board" width="500" height="500" tabindex="0"></canvas>
        </div>
        <div class="game-over" id="game-over">
            <h2>æ¸¸æˆç»“æŸ!</h2>
            <p>ä½ çš„æœ€ç»ˆå¾—åˆ†: <span id="final-score">0</span></p>
            <button class="restart-btn" id="restart-btn">å†ç©ä¸€æ¬¡</button>
        </div>
        <div class="word-complete" id="word-complete">
            <h2>å•è¯å®Œæˆ!</h2>
            <p id="completed-word">apple [è‹¹æœ]</p>
            <div>
                <button class="speech-btn" id="speak-word-btn" tabindex="0">ğŸ”Š <span>å¬è¯»éŸ³</span></button>
                <button class="continue-btn" id="continue-btn" tabindex="0">ç»§ç»­æ¸¸æˆ</button>
            </div>
        </div>
    </div>
    
    <!-- é€Ÿåº¦æ§åˆ¶æ¡ -->
    <div class="speed-control" id="speed-control">
        <label for="speed-range" style="white-space:nowrap;">è›‡é€Ÿï¼š</label>
        <input type="range" id="speed-range" min="100" max="400" step="20" value="300">
        <span id="speed-label">æ™®é€š</span>
    </div>
    
    <!-- Mobile hint will be inserted here by JS -->
    
    <button class="instructions-button" id="instructions-button">ğŸ“ æ¸¸æˆè§„åˆ™è¯´æ˜</button>
    
    <div class="instructions" id="instructions">
        <div class="instructions-content">
            <span class="close-instructions" id="close-instructions">&times;</span>
            <h3>ğŸ“ æ¸¸æˆè§„åˆ™è¯´æ˜</h3>
            <ol>
                <li><strong>æ§åˆ¶æ–¹å¼</strong>ï¼šåœ¨å±å¹•ä¸Šæ»‘åŠ¨æ¥æ§åˆ¶å°è›‡ç§»åŠ¨æ–¹å‘
                    <ul>
                        <li>å‘ä¸Šæ»‘åŠ¨ï¼šè›‡å‘ä¸Šç§»åŠ¨</li>
                        <li>å‘ä¸‹æ»‘åŠ¨ï¼šè›‡å‘ä¸‹ç§»åŠ¨</li>
                        <li>å‘å·¦æ»‘åŠ¨ï¼šè›‡å‘å·¦ç§»åŠ¨</li>
                        <li>å‘å³æ»‘åŠ¨ï¼šè›‡å‘å³ç§»åŠ¨</li>
                    </ul>
                </li>
                <li><strong>æ¸¸æˆç›®æ ‡</strong>ï¼šæŒ‰ç…§å½“å‰å•è¯çš„å­—æ¯é¡ºåºåƒæ‰æ­£ç¡®çš„å­—æ¯</li>
                <li><strong>é£Ÿç‰©è§„åˆ™</strong>ï¼š
                    <ul>
                        <li>æ¯æ¬¡ä¼šå‡ºç°3ä¸ªå­—æ¯é£Ÿç‰©å—ï¼Œå…¶ä¸­1ä¸ªæ˜¯æ­£ç¡®çš„</li>
                        <li>æ­£ç¡®å­—æ¯æ˜¯å½“å‰å•è¯çš„ä¸‹ä¸€ä¸ªå­—æ¯</li>
                        <li>æ­£ç¡®å­—æ¯çš„ä½ç½®å’Œé¢œè‰²æ¯æ¬¡éšæœºå˜åŒ–</li>
                    </ul>
                </li>
                <li><strong>å¾—åˆ†è§„åˆ™</strong>ï¼š
                    <ul>
                        <li>åƒå¯¹æ­£ç¡®å­—æ¯ï¼šè›‡èº«å˜é•¿+10åˆ†</li>
                        <li>åƒé”™å­—æ¯ï¼š-5åˆ†ï¼Œå¹¶æ›´æ¢æ–°å•è¯</li>
                        <li>å®Œæˆæ•´ä¸ªå•è¯ï¼šé¢å¤–+50åˆ†</li>
                    </ul>
                </li>
                <li><strong>éš¾åº¦è°ƒèŠ‚</strong>ï¼šå¯é€šè¿‡ä¸‹æ–¹æ»‘å—è°ƒæ•´è›‡çš„é€Ÿåº¦ï¼Œé€Ÿåº¦è¶Šå¿«éš¾åº¦è¶Šé«˜</li>
                <li><strong>ç‰¹æ®Šæ•ˆæœ</strong>ï¼š
                    <ul>
                        <li>ç¢°åˆ°å¢™å£ä¼šä»å¦ä¸€è¾¹ç©¿å‡º</li>
                        <li>å®Œæˆå•è¯åæ¸¸æˆæš‚åœï¼Œç‚¹å‡»ç»§ç»­åç»§ç»­æ¸¸æˆ</li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>

    <script>
        // æ¸¸æˆå¸¸é‡
        const GRID_SIZE = 20;
        let GAME_WIDTH = 500;
        let GAME_HEIGHT = 500; // Make it square
        let GRID_COLS = GAME_WIDTH / GRID_SIZE;
        let GRID_ROWS = GAME_HEIGHT / GRID_SIZE;
        
        const GENERIC_ICON_URL = "https://cdn-icons-png.flaticon.com/128/1005/1005037.png"; 

        // æ¸¸æˆéŸ³æ•ˆ
        const SOUNDS = {
            correct: {
                src: 'https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3',
                volume: 0.4
            },
            wrong: {
                src: 'https://assets.mixkit.co/active_storage/sfx/2955/2955-preview.mp3',
                volume: 0.3
            },
            complete: {
                src: 'https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3',
                volume: 0.4
            },
            gameover: {
                src: 'https://assets.mixkit.co/active_storage/sfx/254/254-preview.mp3',
                volume: 0.5
            }
        };
        
        // éŸ³æ•ˆç¼“å­˜
        const audioCache = {};
        let audioPlaying = false;
        
        // æ’­æ”¾éŸ³æ•ˆå‡½æ•°
        function playSound(type) {
            // æ£€æŸ¥æ˜¯å¦æ”¯æŒéŸ³é¢‘
            if (!window.Audio) return;
            
            try {
                // å¦‚æœå·²ç»ç¼“å­˜äº†è¿™ä¸ªéŸ³æ•ˆï¼Œåˆ™ä½¿ç”¨ç¼“å­˜
                if (!audioCache[type]) {
                    if (!SOUNDS[type]) return;
                    
                    const audio = new Audio(SOUNDS[type].src);
                    audio.volume = SOUNDS[type].volume || 0.5;
                    audioCache[type] = audio;
                }
                
                // æ’­æ”¾éŸ³æ•ˆï¼ˆå¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œåˆ™é‡ç½®å¹¶é‡æ–°æ’­æ”¾ï¼‰
                const sound = audioCache[type];
                sound.currentTime = 0;
                
                // æ·»åŠ ç»“æŸäº‹ä»¶
                const playPromise = sound.play();
                if (playPromise !== undefined) {
                    audioPlaying = true;
                    
                    playPromise.then(() => {
                        // éŸ³é¢‘æ’­æ”¾æˆåŠŸ
                        sound.onended = () => {
                            audioPlaying = false;
                        };
                    }).catch(e => {
                        console.log('æ— æ³•æ’­æ”¾éŸ³æ•ˆ:', e);
                        audioPlaying = false;
                    });
                }
            } catch (e) {
                console.log('æ’­æ”¾éŸ³æ•ˆæ—¶å‡ºé”™:', e);
                audioPlaying = false;
            }
        }
        
        // è¯­éŸ³åˆæˆå‡½æ•° - ç¡®ä¿ä¸ä¼šä¸å…¶ä»–éŸ³æ•ˆå†²çª
        function speakWord(word) {
            if (!word) return;
            
            // ç­‰å¾…å½“å‰éŸ³æ•ˆæ’­æ”¾å®Œæˆ
            if (audioPlaying) {
                setTimeout(() => speakWord(word), 300);
                return;
            }
            
            // å°è¯•ä½¿ç”¨åœ¨çº¿API
            const utterance = encodeURIComponent(word.toLowerCase().trim());
            const audioElement = new Audio(`https://ssl.gstatic.com/dictionary/static/sounds/20200429/${utterance}--_gb_1.mp3`);
            
            audioElement.onerror = function() {
                // å¦‚æœåœ¨çº¿APIå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨è¯­éŸ³åˆæˆAPI
                if ('speechSynthesis' in window) {
                    try {
                        // å–æ¶ˆä»»ä½•æ­£åœ¨è¿›è¡Œçš„è¯­éŸ³
                        window.speechSynthesis.cancel();
                        
                        const speech = new SpeechSynthesisUtterance(word);
                        speech.lang = 'en-US';
                        speech.rate = 0.8;
                        speech.pitch = 1;
                        speech.volume = 0.8;
                        
                        window.speechSynthesis.speak(speech);
                    } catch (e) {
                        console.log('è¯­éŸ³åˆæˆå‡ºé”™:', e);
                    }
                } else {
                    console.log('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆ');
                }
            };
            
            // å°è¯•æ’­æ”¾åœ¨çº¿éŸ³é¢‘
            audioElement.play().catch(e => {
                console.log('åœ¨çº¿éŸ³é¢‘æ’­æ”¾å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨è¯­éŸ³åˆæˆ:', e);
                audioElement.onerror();
            });
        }

        const WORD_GROUPS = {
            1: [
                { word: "ten", meaning: "å", icon: GENERIC_ICON_URL }, { word: "twenty", meaning: "äºŒå", icon: GENERIC_ICON_URL },
                { word: "thirty", meaning: "ä¸‰å", icon: GENERIC_ICON_URL }, { word: "forty", meaning: "å››å", icon: GENERIC_ICON_URL },
                { word: "fifty", meaning: "äº”å", icon: GENERIC_ICON_URL }
            ],
            2: [
                { word: "sixty", meaning: "å…­å", icon: GENERIC_ICON_URL }, { word: "seventy", meaning: "ä¸ƒå", icon: GENERIC_ICON_URL },
                { word: "eighty", meaning: "å…«å", icon: GENERIC_ICON_URL }, { word: "ninety", meaning: "ä¹å", icon: GENERIC_ICON_URL },
                { word: "one hundred", meaning: "ä¸€ç™¾", icon: GENERIC_ICON_URL }
            ],
            3: [
                { word: "fifth", meaning: "ç¬¬äº”", icon: GENERIC_ICON_URL }, { word: "third", meaning: "ç¬¬ä¸‰", icon: GENERIC_ICON_URL },
                { word: "fourth", meaning: "ç¬¬å››", icon: GENERIC_ICON_URL }, { word: "first", meaning: "ç¬¬ä¸€", icon: GENERIC_ICON_URL },
                { word: "second", meaning: "ç¬¬äºŒ", icon: GENERIC_ICON_URL }
            ],
            4: [
                { word: "one", meaning: "ä¸€", icon: GENERIC_ICON_URL }, { word: "two", meaning: "äºŒ", icon: GENERIC_ICON_URL },
                { word: "three", meaning: "ä¸‰", icon: GENERIC_ICON_URL }, { word: "four", meaning: "å››", icon: GENERIC_ICON_URL },
                { word: "five", meaning: "äº”", icon: GENERIC_ICON_URL }
            ],
            5: [
                { word: "six", meaning: "å…­", icon: GENERIC_ICON_URL }, { word: "seven", meaning: "ä¸ƒ", icon: GENERIC_ICON_URL },
                { word: "eight", meaning: "å…«", icon: GENERIC_ICON_URL }, { word: "nine", meaning: "ä¹", icon: GENERIC_ICON_URL },
                { word: "ten", meaning: "å", icon: GENERIC_ICON_URL }
            ],
            6: [
                { word: "heart", meaning: "å¿ƒå½¢", icon: GENERIC_ICON_URL }, { word: "star", meaning: "äº”è§’æ˜Ÿ", icon: GENERIC_ICON_URL },
                { word: "rectangle", meaning: "é•¿æ–¹å½¢", icon: GENERIC_ICON_URL }, { word: "circle", meaning: "åœ†å½¢", icon: GENERIC_ICON_URL },
                { word: "square", meaning: "æ­£æ–¹å½¢", icon: GENERIC_ICON_URL }, { word: "triangle", meaning: "ä¸‰è§’å½¢", icon: GENERIC_ICON_URL }
            ],
            7: [
                { word: "butterfly", meaning: "è´è¶", icon: GENERIC_ICON_URL }, { word: "bee", meaning: "èœœèœ‚", icon: GENERIC_ICON_URL },
                { word: "cricket", meaning: "èŸ‹èŸ€", icon: GENERIC_ICON_URL }, { word: "ant", meaning: "èš‚èš", icon: GENERIC_ICON_URL },
                { word: "worm", meaning: "è™«å­", icon: GENERIC_ICON_URL }, { word: "spider", meaning: "èœ˜è››", icon: GENERIC_ICON_URL }
            ],
            8: [
                { word: "insect", meaning: "æ˜†è™«", icon: GENERIC_ICON_URL }, { word: "web", meaning: "ç½‘", icon: GENERIC_ICON_URL },
                { word: "behind", meaning: "åœ¨â€¦åé¢", icon: GENERIC_ICON_URL }, { word: "in front", meaning: "åœ¨â€¦å‰é¢", icon: GENERIC_ICON_URL },
                { word: "above", meaning: "åœ¨â€¦ä¸Šé¢", icon: GENERIC_ICON_URL }, { word: "between", meaning: "åœ¨â€¦ä¸­é—´", icon: GENERIC_ICON_URL }
            ],
            9: [
                { word: "cage", meaning: "ç¬¼å­", icon: GENERIC_ICON_URL }, { word: "winter", meaning: "å†¬å¤©", icon: GENERIC_ICON_URL },
                { word: "rice", meaning: "ç±³é¥­", icon: GENERIC_ICON_URL }, { word: "pet", meaning: "å® ç‰©", icon: GENERIC_ICON_URL },
                { word: "keep", meaning: "å…»", icon: GENERIC_ICON_URL }
            ],
            10: [
                { word: "when", meaning: "ä»€ä¹ˆæ—¶å€™", icon: GENERIC_ICON_URL }, { word: "why", meaning: "ä¸ºä»€ä¹ˆ", icon: GENERIC_ICON_URL },
                { word: "what", meaning: "ä»€ä¹ˆ", icon: GENERIC_ICON_URL }, { word: "who", meaning: "è°", icon: GENERIC_ICON_URL },
                { word: "where", meaning: "å“ªé‡Œ", icon: GENERIC_ICON_URL }, { word: "how", meaning: "å¦‚ä½•", icon: GENERIC_ICON_URL }
            ],
            11: [
                { word: "knee", meaning: "è†ç›–", icon: GENERIC_ICON_URL }, { word: "flea", meaning: "è·³èš¤", icon: GENERIC_ICON_URL },
                { word: "me", meaning: "æˆ‘", icon: GENERIC_ICON_URL }, { word: "eat", meaning: "åƒ", icon: GENERIC_ICON_URL },
                { word: "she", meaning: "å¥¹", icon: GENERIC_ICON_URL }, { word: "foot", meaning: "è„š", icon: GENERIC_ICON_URL }
            ],
            12: [
                { word: "recycle", meaning: "å¯å›æ”¶", icon: GENERIC_ICON_URL }, { word: "picking", meaning: "æ¡èµ·/æ‹¾", icon: GENERIC_ICON_URL },
                { word: "bin", meaning: "åƒåœ¾æ¡¶", icon: GENERIC_ICON_URL }, { word: "planting", meaning: "ç§æ¤", icon: GENERIC_ICON_URL },
                { word: "watering", meaning: "æµ‡æ°´", icon: GENERIC_ICON_URL }
            ],
            13: [
                { word: "friend", meaning: "æœ‹å‹", icon: GENERIC_ICON_URL }, { word: "aunt", meaning: "é˜¿å§¨", icon: GENERIC_ICON_URL },
                { word: "uncle", meaning: "å”å”", icon: GENERIC_ICON_URL }, { word: "grandma", meaning: "å¥¶å¥¶", icon: GENERIC_ICON_URL },
                { word: "grandpa", meaning: "çˆ·çˆ·", icon: GENERIC_ICON_URL }
            ],
            14: [
                { word: "mother", meaning: "å¦ˆå¦ˆ", icon: GENERIC_ICON_URL }, { word: "father", meaning: "çˆ¸çˆ¸", icon: GENERIC_ICON_URL },
                { word: "brother", meaning: "å…„å¼Ÿ", icon: GENERIC_ICON_URL }, { word: "sister", meaning: "å§å¦¹", icon: GENERIC_ICON_URL }
            ],
            15: [
                { word: "stem", meaning: "èŒ", icon: GENERIC_ICON_URL }, { word: "leaf", meaning: "å¶å­", icon: GENERIC_ICON_URL },
                { word: "tree", meaning: "æ ‘", icon: GENERIC_ICON_URL }, { word: "flower", meaning: "èŠ±", icon: GENERIC_ICON_URL },
                { word: "roots", meaning: "æ ¹", icon: GENERIC_ICON_URL }
            ],
            16: [
                { word: "this", meaning: "è¿™ä¸ª", icon: GENERIC_ICON_URL }, { word: "that", meaning: "é‚£ä¸ª", icon: GENERIC_ICON_URL },
                { word: "these", meaning: "è¿™äº›", icon: GENERIC_ICON_URL }, { word: "those", meaning: "é‚£äº›", icon: GENERIC_ICON_URL },
                { word: "they", meaning: "ä»–ä»¬", icon: GENERIC_ICON_URL }
            ],
            17: [
                { word: "basket", meaning: "ç¯®å­", icon: GENERIC_ICON_URL }, { word: "railing", meaning: "æ æ†", icon: GENERIC_ICON_URL },
                { word: "ladder", meaning: "æ¢¯å­", icon: GENERIC_ICON_URL }, { word: "stairs", meaning: "æ¥¼æ¢¯", icon: GENERIC_ICON_URL },
                { word: "roof", meaning: "å±‹é¡¶", icon: GENERIC_ICON_URL }, { word: "wall", meaning: "å¢™", icon: GENERIC_ICON_URL }
            ],
            18: [
                { word: "hall", meaning: "é—¨å…", icon: GENERIC_ICON_URL }, { word: "bedroom", meaning: "å§å®¤", icon: GENERIC_ICON_URL },
                { word: "kitchen", meaning: "å¨æˆ¿", icon: GENERIC_ICON_URL }, { word: "garden", meaning: "èŠ±å›­", icon: GENERIC_ICON_URL },
                { word: "bathroom", meaning: "æµ´å®¤", icon: GENERIC_ICON_URL }
            ],
            19: [
                { word: "floor", meaning: "åœ°æ¿", icon: GENERIC_ICON_URL }, { word: "bed", meaning: "åºŠ", icon: GENERIC_ICON_URL },
                { word: "clean", meaning: "æ¸…ç†/å¹²å‡€", icon: GENERIC_ICON_URL }, { word: "table", meaning: "æ¡Œå­", icon: GENERIC_ICON_URL },
                { word: "sink", meaning: "æ°´æ§½", icon: GENERIC_ICON_URL }
            ],
            20: [
                { word: "warm", meaning: "æ¸©æš–çš„", icon: GENERIC_ICON_URL }, { word: "cold", meaning: "å†·çš„", icon: GENERIC_ICON_URL },
                { word: "cool", meaning: "å‡‰çˆ½çš„", icon: GENERIC_ICON_URL }, { word: "hot", meaning: "çƒ­çš„", icon: GENERIC_ICON_URL },
                { word: "keep", meaning: "ä¿æŒ", icon: GENERIC_ICON_URL } 
            ],
            21: [
                { word: "goose", meaning: "é¹…", icon: GENERIC_ICON_URL }, { word: "moon", meaning: "æœˆäº®", icon: GENERIC_ICON_URL },
                { word: "cooker", meaning: "å¨å¸ˆ", icon: GENERIC_ICON_URL }, { word: "good", meaning: "å¥½çš„", icon: GENERIC_ICON_URL },
                { word: "look", meaning: "çœ‹", icon: GENERIC_ICON_URL }, { word: "book", meaning: "ä¹¦", icon: GENERIC_ICON_URL }
            ],
            22: [
                { word: "zoo", meaning: "åŠ¨ç‰©å›­", icon: GENERIC_ICON_URL }, { word: "big", meaning: "å¤§çš„", icon: GENERIC_ICON_URL },
                { word: "strong", meaning: "å¼ºå£®çš„", icon: GENERIC_ICON_URL }, { word: "tiny", meaning: "å¾®å°çš„", icon: GENERIC_ICON_URL },
                { word: "clever", meaning: "èªæ˜çš„", icon: GENERIC_ICON_URL }
            ],
            23: [
                { word: "loud", meaning: "å¤§å£°çš„", icon: GENERIC_ICON_URL }, { word: "quiet", meaning: "å°å£°çš„", icon: GENERIC_ICON_URL },
                { word: "tired", meaning: "ç–²åŠ³çš„", icon: GENERIC_ICON_URL }, { word: "happy", meaning: "å¿«ä¹çš„", icon: GENERIC_ICON_URL },
                { word: "busy", meaning: "å¿™ç¢Œçš„", icon: GENERIC_ICON_URL }, { word: "kind", meaning: "å–„è‰¯çš„", icon: GENERIC_ICON_URL },
                { word: "friendly", meaning: "å‹å¥½çš„", icon: GENERIC_ICON_URL }
            ],
            24: [
                { word: "count", meaning: "æ•°", icon: GENERIC_ICON_URL }, { word: "jump", meaning: "è·³", icon: GENERIC_ICON_URL },
                { word: "walk", meaning: "èµ°", icon: GENERIC_ICON_URL }, { word: "run", meaning: "è·‘", icon: GENERIC_ICON_URL },
                { word: "throw", meaning: "æ‰”", icon: GENERIC_ICON_URL }, { word: "catch", meaning: "æŠ“ä½", icon: GENERIC_ICON_URL }
            ],
            25: [
                { word: "bite", meaning: "å’¬", icon: GENERIC_ICON_URL }, { word: "live", meaning: "ä½", icon: GENERIC_ICON_URL },
                { word: "move", meaning: "ç§»åŠ¨", icon: GENERIC_ICON_URL }, { word: "chase", meaning: "è¿½", icon: GENERIC_ICON_URL },
                { word: "lift up", meaning: "ä¸¾èµ·", icon: GENERIC_ICON_URL }, { word: "shiver", meaning: "é¢¤æŠ–", icon: GENERIC_ICON_URL },
                { word: "scare", meaning: "å“å”¬", icon: GENERIC_ICON_URL }
            ],
            // Group 26 is skipped
            27: [
                { word: "read", meaning: "è¯»", icon: GENERIC_ICON_URL }, { word: "climb", meaning: "çˆ¬", icon: GENERIC_ICON_URL },
                { word: "cut", meaning: "åˆ‡", icon: GENERIC_ICON_URL }, { word: "talk", meaning: "äº¤è°ˆ", icon: GENERIC_ICON_URL },
                { word: "swim", meaning: "æ¸¸æ³³", icon: GENERIC_ICON_URL }, { word: "stand", meaning: "ç«™", icon: GENERIC_ICON_URL },
                { word: "fall", meaning: "æ‰è½", icon: GENERIC_ICON_URL }
            ],
            28: [
                { word: "come", meaning: "æ¥", icon: GENERIC_ICON_URL }, { word: "sit", meaning: "å", icon: GENERIC_ICON_URL },
                { word: "help", meaning: "å¸®åŠ©", icon: GENERIC_ICON_URL }, { word: "grow", meaning: "ç”Ÿé•¿", icon: GENERIC_ICON_URL },
                { word: "call", meaning: "å‘¼å«", icon: GENERIC_ICON_URL }, { word: "play", meaning: "ç©", icon: GENERIC_ICON_URL },
                { word: "need", meaning: "éœ€è¦", icon: GENERIC_ICON_URL }
            ],
            29: [
                { word: "stand", meaning: "ç«™", icon: GENERIC_ICON_URL }, { word: "wave", meaning: "æŒ¥æ‰‹", icon: GENERIC_ICON_URL }, 
                { word: "hop", meaning: "å•è„šè·³", icon: GENERIC_ICON_URL }, { word: "wiggle", meaning: "æ‰­åŠ¨", icon: GENERIC_ICON_URL },
                { word: "nod", meaning: "ç‚¹å¤´", icon: GENERIC_ICON_URL }, { word: "touch", meaning: "è§¦æ‘¸", icon: GENERIC_ICON_URL }
            ],
            30: [
                { word: "clock", meaning: "é’Ÿ", icon: GENERIC_ICON_URL }, { word: "calendar", meaning: "æ—¥å†", icon: GENERIC_ICON_URL },
                { word: "tablet", meaning: "å¹³æ¿", icon: GENERIC_ICON_URL }, { word: "book", meaning: "ä¹¦", icon: GENERIC_ICON_URL }, 
                { word: "map", meaning: "åœ°å›¾", icon: GENERIC_ICON_URL }
            ],
            31: [
                { word: "ball", meaning: "çƒ", icon: GENERIC_ICON_URL }, { word: "skipping", meaning: "è·³ç»³", icon: GENERIC_ICON_URL },
                { word: "phone", meaning: "æ‰‹æœº", icon: GENERIC_ICON_URL }, { word: "pencil", meaning: "é“…ç¬”", icon: GENERIC_ICON_URL },
                { word: "hat", meaning: "å¸½å­", icon: GENERIC_ICON_URL }, { word: "key", meaning: "é’¥åŒ™", icon: GENERIC_ICON_URL }
            ],
            32: [
                { word: "sunglasses", meaning: "å¤ªé˜³é•œ", icon: GENERIC_ICON_URL }, { word: "outside", meaning: "å¤–é¢", icon: GENERIC_ICON_URL },
                { word: "window cleaner", meaning: "çª—æˆ·æ¸…æ´å·¥", icon: GENERIC_ICON_URL }, { word: "police officer", meaning: "è­¦å¯Ÿ", icon: GENERIC_ICON_URL },
                { word: "reporter", meaning: "è®°è€…", icon: GENERIC_ICON_URL }
            ],
            33: [
                { word: "helmet", meaning: "å¤´ç›”", icon: GENERIC_ICON_URL }, { word: "gloves", meaning: "æ‰‹å¥—", icon: GENERIC_ICON_URL },
                { word: "mask", meaning: "é¢å…·", icon: GENERIC_ICON_URL }, { word: "nurse", meaning: "æŠ¤å£«", icon: GENERIC_ICON_URL },
                { word: "boot", meaning: "é´å­", icon: GENERIC_ICON_URL }, { word: "driver", meaning: "å¸æœº", icon: GENERIC_ICON_URL },
                { word: "jacket", meaning: "å¤¹å…‹", icon: GENERIC_ICON_URL }
            ],
            34: [
                { word: "apple", meaning: "è‹¹æœ", icon: GENERIC_ICON_URL }, { word: "orange", meaning: "æ©˜å­", icon: GENERIC_ICON_URL },
                { word: "carrots", meaning: "èƒ¡èåœ", icon: GENERIC_ICON_URL }, { word: "soup", meaning: "æ±¤", icon: GENERIC_ICON_URL },
                { word: "milk", meaning: "ç‰›å¥¶", icon: GENERIC_ICON_URL }, { word: "yogurt", meaning: "é…¸å¥¶", icon: GENERIC_ICON_URL }
            ],
            35: [
                { word: "shadow", meaning: "å½±å­", icon: GENERIC_ICON_URL }, { word: "high", meaning: "é«˜çš„", icon: GENERIC_ICON_URL },
                { word: "low", meaning: "ä½çš„", icon: GENERIC_ICON_URL }, { word: "some", meaning: "ä¸€äº›", icon: GENERIC_ICON_URL },
                { word: "most", meaning: "å¤§éƒ¨åˆ†", icon: GENERIC_ICON_URL }, { word: "all", meaning: "æ‰€æœ‰", icon: GENERIC_ICON_URL },
                { word: "sky", meaning: "å¤©ç©º", icon: GENERIC_ICON_URL }
            ],
            36: [
                { word: "moon", meaning: "æœˆäº®", icon: GENERIC_ICON_URL }, { word: "long", meaning: "é•¿çš„", icon: GENERIC_ICON_URL }, 
                { word: "short", meaning: "çŸ­çš„", icon: GENERIC_ICON_URL }, { word: "sun", meaning: "å¤ªé˜³", icon: GENERIC_ICON_URL },
                { word: "star", meaning: "æ˜Ÿæ˜Ÿ", icon: GENERIC_ICON_URL }, { word: "earth", meaning: "åœ°çƒ", icon: GENERIC_ICON_URL },
                { word: "planet", meaning: "æ˜Ÿçƒ", icon: GENERIC_ICON_URL }
            ]
        };
        
        // æ¸¸æˆå˜é‡
        let snake = [];
        let direction = "RIGHT";
        let nextDirection = "RIGHT";
        let food = [];
        let currentWordList = []; // Holds words from the selected group
        let currentWord = null;
        let nextLetterIndex = 0;
        let score = 0;
        let combo = 0;
        let maxCombo = 0;
        let gameSpeed = 200;
        let gameLoop;
        let gameOver = false;
        let gamePaused = false;
        let isWordCompletePopupActive = false; // New flag
        
        // DOMå…ƒç´ 
        const canvas = document.getElementById("game-board");
        const ctx = canvas.getContext("2d");
        const wordMeaningEl = document.getElementById("word-meaning");
        const wordIconEl = document.getElementById("word-icon");
        const scoreEl = document.getElementById("score");
        const comboEl = document.getElementById("combo");
        const maxComboEl = document.getElementById("max-combo");
        const gameOverEl = document.getElementById("game-over");
        const wordCompleteEl = document.getElementById("word-complete");
        const completedWordEl = document.getElementById("completed-word");
        const finalScoreEl = document.getElementById("final-score");
        const restartBtn = document.getElementById("restart-btn");
        const continueBtn = document.getElementById("continue-btn");
        const instructionsButton = document.getElementById("instructions-button");
        const instructionsElement = document.getElementById("instructions");
        const closeInstructions = document.getElementById("close-instructions");
        const wordGroupSelect = document.getElementById("word-group-select");
        
        // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡ï¼Œæ·»åŠ ç›¸åº”æç¤º
        const isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        if (isMobileDevice) {
            // æ·»åŠ ç§»åŠ¨è®¾å¤‡æ“ä½œæç¤º
            const mobileHint = document.createElement("div");
            mobileHint.className = "mobile-hint";
            mobileHint.textContent = "åœ¨æ¸¸æˆåŒºåŸŸæ»‘åŠ¨å¯æ§åˆ¶è›‡çš„æ–¹å‘";
            
            // æ’å…¥åˆ°æ¸¸æˆåŒºåŸŸä¸‹é¢ï¼Œæ¸¸æˆè§„åˆ™è¯´æ˜æŒ‰é’®ä¸Šé¢
            const instructionsButton = document.getElementById("instructions-button");
            instructionsButton.parentNode.insertBefore(mobileHint, instructionsButton);
        }
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            adjustGameSize();
            
            snake = [
                { x: 5, y: 10 },
                { x: 4, y: 10 },
                { x: 3, y: 10 }
            ];
            direction = "RIGHT";
            nextDirection = "RIGHT";
            score = 0;
            combo = 0;
            maxCombo = 0;
            gameOver = false;
            gamePaused = false;
            isWordCompletePopupActive = false;
            gameOverEl.style.display = "none";
            wordCompleteEl.style.display = "none";
            
            selectNewWord();
            generateFood();
            updateUI();
            
            if (gameLoop) clearInterval(gameLoop);
            gameLoop = setInterval(gameStep, gameSpeed);
            canvas.focus();
        }
        
        // å“åº”å¼è°ƒæ•´æ¸¸æˆå¤§å°
        function adjustGameSize() {
            const isMobile = window.innerWidth <= 600;
            
            // è®¾ç½®åŸºç¡€æ¸¸æˆå°ºå¯¸
            if (isMobile) {
                let screenWidth = Math.min(window.innerWidth * 0.9, 350);
                GAME_WIDTH = Math.floor(screenWidth / GRID_SIZE) * GRID_SIZE;
                GAME_HEIGHT = GAME_WIDTH; // æ­£æ–¹å½¢
            } else {
                GAME_WIDTH = 500;
                GAME_HEIGHT = 500;
            }
            
            // è®¡ç®—ç½‘æ ¼å•å…ƒæ•°é‡
            GRID_COLS = Math.floor(GAME_WIDTH / GRID_SIZE);
            GRID_ROWS = Math.floor(GAME_HEIGHT / GRID_SIZE);
            GAME_WIDTH = GRID_COLS * GRID_SIZE; // ç¡®ä¿å°ºå¯¸æ˜¯ç½‘æ ¼å•å…ƒçš„ç²¾ç¡®å€æ•°
            GAME_HEIGHT = GRID_ROWS * GRID_SIZE;
            
            // è®¾ç½®è¾¹æ¡†å’ŒCanvaså°ºå¯¸
            const wrapper = document.querySelector('.canvas-wrapper');
            if (wrapper) {
                const borderWidth = parseInt(getComputedStyle(wrapper).borderWidth) || (isMobile ? 8 : 10);
                
                if (isMobile) {
                    // ç§»åŠ¨è®¾å¤‡: è®¡ç®—è¾¹æ¡†å†…å¯ç”¨ç©ºé—´
                    const availableWidth = GAME_WIDTH - (borderWidth * 2);
                    const gridAlignedWidth = Math.floor(availableWidth / GRID_SIZE) * GRID_SIZE;
                    
                    // æ›´æ–°Canvaså°ºå¯¸å’Œç½‘æ ¼
                    canvas.width = gridAlignedWidth;
                    canvas.height = gridAlignedWidth;
                    canvas.style.width = gridAlignedWidth + 'px';
                    canvas.style.height = gridAlignedWidth + 'px';
                    GRID_COLS = gridAlignedWidth / GRID_SIZE;
                    GRID_ROWS = gridAlignedWidth / GRID_SIZE;
                    
                    // è®¾ç½®è¾¹æ¡†å®¹å™¨å°ºå¯¸
                    wrapper.style.width = GAME_WIDTH + 'px';
                    wrapper.style.height = GAME_HEIGHT + 'px';
                } else {
                    // æ¡Œé¢è®¾å¤‡: å¸¸è§„è®¾ç½®å¹¶ä¿®å¤è¾¹æ¡†å¯¹é½
                    canvas.width = GAME_WIDTH;
                    canvas.height = GAME_HEIGHT;
                    canvas.style.width = GAME_WIDTH + 'px';
                    canvas.style.height = GAME_HEIGHT + 'px';
                    wrapper.style.width = (GAME_WIDTH - 1) + 'px'; // ä¿®å¤å³ä¾§è¾¹æ¡†å¯¹é½
                    wrapper.style.height = GAME_HEIGHT + 'px';
                }
                wrapper.style.boxSizing = 'content-box';
            }
            
            // ç¡®ä¿è›‡åœ¨ç½‘æ ¼èŒƒå›´å†…
            for (let i = 0; i < snake.length; i++) {
                snake[i].x = Math.min(snake[i].x, GRID_COLS - 1);
                snake[i].y = Math.min(snake[i].y, GRID_ROWS - 1);
            }
            
            generateFood();
            drawGame();
        }
        
        // ç›‘å¬çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', () => {
            if (!gameOver && !gamePaused) {
                // æš‚åœæ¸¸æˆï¼Œè°ƒæ•´å¤§å°åç»§ç»­
                clearInterval(gameLoop);
                adjustGameSize();
                drawGame(); // é‡æ–°ç»˜åˆ¶
                gameLoop = setInterval(gameStep, gameSpeed);
            } else {
                adjustGameSize();
                drawGame(); // é‡æ–°ç»˜åˆ¶
            }
        });
        
        // æ›´æ¢å•è¯ç»„ä½†ä¿æŒè›‡çš„çŠ¶æ€
        function changeWordGroup(newGroupKey) {
            // Only change the word list but keep snake state
            if (newGroupKey === "all") {
                createCombinedWordList();
            } else if (WORD_GROUPS[newGroupKey]) {
                currentWordList = WORD_GROUPS[newGroupKey];
            }
            
            // Unpause if paused from word completion
            if (gamePaused && isWordCompletePopupActive) {
                gamePaused = false;
                isWordCompletePopupActive = false;
            }
            
            // Clear any popups
            gameOverEl.style.display = "none";
            wordCompleteEl.style.display = "none";
            
            // Get a new word and food
            selectNewWord();
            generateFood();
            updateUI();
            
            // Ensure the game is running
            if (!gameLoop || gameOver) {
                if (gameLoop) clearInterval(gameLoop);
                gameLoop = setInterval(gameStep, gameSpeed);
            }
            
            canvas.focus();
        }
        
        // é€‰æ‹©æ–°å•è¯
        function selectNewWord() {
            if (!currentWordList || currentWordList.length === 0) {
                const firstGroupKey = Object.keys(WORD_GROUPS)[0];
                if (WORD_GROUPS[firstGroupKey]) {
                    currentWordList = WORD_GROUPS[firstGroupKey];
                    if (wordGroupSelect.value !== firstGroupKey) { 
                        wordGroupSelect.value = firstGroupKey;
                    }
                } else {
                    alert("é”™è¯¯ï¼šå•è¯åˆ—è¡¨ä¸ºç©ºï¼");
                    gameOver = true;
                    return;
                }
            }
            currentWord = currentWordList[Math.floor(Math.random() * currentWordList.length)];
            nextLetterIndex = 0;
            updateUI();
        }
        
        // ç”Ÿæˆé£Ÿç‰©ï¼ˆç°åœ¨æ¯æ¬¡ç”Ÿæˆ3ä¸ªå­—æ¯ï¼Œå…¶ä¸­1ä¸ªæ˜¯æ­£ç¡®çš„ï¼‰
        function generateFood() {
            food = [];
            
            if (!currentWord || typeof currentWord.word !== 'string' || nextLetterIndex >= currentWord.word.length) {
                return;
            }
            
            // å½“å‰åº”åƒçš„å­—æ¯
            const currentLetter = currentWord.word[nextLetterIndex];
            
            // éšæœºé€‰æ‹©2ä¸ªé”™è¯¯å­—æ¯
            let wrongLetters = [];
            const otherLettersInWord = currentWord.word.split('').filter((_, i) => i !== nextLetterIndex);
            
            if (otherLettersInWord.length > 0) {
                wrongLetters.push(otherLettersInWord[Math.floor(Math.random() * otherLettersInWord.length)]);
            }
            
            const alphabet = 'abcdefghijklmnopqrstuvwxyz';
            while (wrongLetters.length < 2) {
                const randomLetter = alphabet[Math.floor(Math.random() * alphabet.length)];
                if (randomLetter !== currentLetter && !wrongLetters.includes(randomLetter) && currentWord.word.indexOf(randomLetter) === -1) {
                    wrongLetters.push(randomLetter);
                }
            }
            
            const allLetters = [currentLetter, ...wrongLetters].sort(() => Math.random() - 0.5);
            
            for (let i = 0; i < 3; i++) {
                let foodItem;
                let attempts = 0;
                do {
                    foodItem = {
                        x: Math.floor(Math.random() * GRID_COLS),
                        y: Math.floor(Math.random() * GRID_ROWS),
                        letter: allLetters[i],
                        type: allLetters[i] === currentLetter ? "correct" : "wrong",
                        color: getRandomFoodColor()
                    };
                    attempts++;
                } while (
                    (isPositionOnSnake(foodItem.x, foodItem.y) || 
                    food.some(f => f.x === foodItem.x && f.y === foodItem.y)) && attempts < 100
                );
                if (attempts < 100) {
                    food.push(foodItem);
                }
            }
        }
        
        // è·å–éšæœºé£Ÿç‰©é¢œè‰²ï¼ˆæ­£ç¡®é£Ÿç‰©ç”¨çº¢è‰²ç³»ï¼Œé”™è¯¯é£Ÿç‰©éšæœºé¢œè‰²ï¼‰
        function getRandomFoodColor() {
            const colors = [
                '#ff6b6b', '#ff8787', '#ff5252', // çº¢è‰²ç³»
                '#fcc419', '#ffd43b', '#fab005',   // é»„è‰²ç³»
                '#51cf66', '#40c057', '#37b24d',   // ç»¿è‰²ç³»
                '#339af0', '#228be6', '#1c7ed6',   // è“è‰²ç³»
                '#ae3ec9', '#9c36b5', '#862e9c'    // ç´«è‰²ç³»
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // æ£€æŸ¥ä½ç½®æ˜¯å¦åœ¨è›‡èº«ä¸Š
        function isPositionOnSnake(x, y) {
            return snake.some(segment => segment.x === x && segment.y === y);
        }
        
        // æ¸¸æˆä¸»å¾ªç¯
        function gameStep() {
            if (gameOver || gamePaused) return;
            
            direction = nextDirection;
            
            // ç§»åŠ¨è›‡
            const head = { ...snake[0] };
            
            switch (direction) {
                case "UP": head.y -= 1; break;
                case "DOWN": head.y += 1; break;
                case "LEFT": head.x -= 1; break;
                case "RIGHT": head.x += 1; break;
            }
            
            // ç©¿å¢™å¤„ç†
            if (head.x < 0) head.x = GRID_COLS - 1;
            if (head.x >= GRID_COLS) head.x = 0;
            if (head.y < 0) head.y = GRID_ROWS - 1;
            if (head.y >= GRID_ROWS) head.y = 0;
            
            // æ£€æŸ¥è‡ªèº«ç¢°æ’
            if (snake.some(segment => segment.x === head.x && segment.y === head.y)) {
                endGame();
                return;
            }
            
            snake.unshift(head);
            
            // æ£€æŸ¥æ˜¯å¦åƒåˆ°é£Ÿç‰©
            let eatenFoodIndex = -1;
            for (let i = 0; i < food.length; i++) {
                if (food[i].x === head.x && food[i].y === head.y) {
                    eatenFoodIndex = i;
                    break;
                }
            }
            
            if (eatenFoodIndex !== -1) {
                const eatenFood = food[eatenFoodIndex];
                
                if (eatenFood.type === "correct") {
                    handleCorrectFood();
                } else {
                    handleWrongFood();
                }
                
                generateFood();
            } else {
                snake.pop();
            }
            
            drawGame();
        }
        
        // å¤„ç†åƒå¯¹é£Ÿç‰©
        function handleCorrectFood() {
            const correctFoodItem = food.find(f => f.x === snake[0].x && f.y === snake[0].y && f.type === "correct");
            if (correctFoodItem) {
                showCelebration("+10", correctFoodItem);
            }
            
            score += 10;
            combo += 1;
            if (combo > maxCombo) {
                maxCombo = combo;
            }
            
            nextLetterIndex += 1;
            
            // æ’­æ”¾æ­£ç¡®éŸ³æ•ˆ
            playSound('correct');
            
            if (currentWord && nextLetterIndex >= currentWord.word.length) {
                score += 50;
                showWordComplete();
            }
            updateUI();
        }
        
        // æ˜¾ç¤ºå•è¯å®Œæˆæç¤º
        function showWordComplete() {
            gamePaused = true;
            isWordCompletePopupActive = true;
            completedWordEl.textContent = `${currentWord.word} [${currentWord.meaning}]`;
            wordCompleteEl.style.display = "block";
            
            // æ’­æ”¾å®ŒæˆéŸ³æ•ˆ
            playSound('complete');
            
            // å»¶è¿Ÿåå°è¯•å‘éŸ³ï¼Œç¡®ä¿å®ƒä¸ä¸å®ŒæˆéŸ³æ•ˆå†²çª
            safelySpeak();
            
            // èšç„¦ç»§ç»­æŒ‰é’®æ–¹ä¾¿é”®ç›˜æ“ä½œ
            setTimeout(() => {
                continueBtn.focus();
            }, 100);
        }
        
        // ç»§ç»­æ¸¸æˆ
        function continueGame() {
            gamePaused = false;
            isWordCompletePopupActive = false; // Reset flag
            wordCompleteEl.style.display = "none";
            selectNewWord(); 
            generateFood();
            updateUI();
            canvas.focus(); // Ensure canvas gets focus after continuing
        }
        
        // å¤„ç†åƒé”™é£Ÿç‰©
        function handleWrongFood() {
            const wrongFoodItem = food.find(f => f.x === snake[0].x && f.y === snake[0].y && f.type === "wrong");
            if (wrongFoodItem) {
                showPenalty("-5", wrongFoodItem);
            }

            score = Math.max(0, score - 5);
            
            // ä¸å†ç¼©çŸ­è›‡çš„é•¿åº¦
            combo = 0;
            selectNewWord();
            updateUI();
            
            // æ’­æ”¾é”™è¯¯éŸ³æ•ˆ
            playSound('wrong');
        }
        
        // æ˜¾ç¤ºåº†ç¥æ•ˆæœ
        function showCelebration(text, position) {
            const celebration = document.createElement("div");
            celebration.className = "celebration";
            celebration.textContent = text;
            // Ensure position is valid and apply styles
            if (position && typeof position.x === 'number' && typeof position.y === 'number') {
                celebration.style.left = `${position.x * GRID_SIZE}px`;
                celebration.style.top = `${position.y * GRID_SIZE}px`;
            }
            document.querySelector(".game-container").appendChild(celebration);
            
            setTimeout(() => {
                celebration.remove();
            }, 1500);
        }
        
        // æ˜¾ç¤ºæƒ©ç½šæ•ˆæœ
        function showPenalty(text, position) {
            const penalty = document.createElement("div");
            penalty.className = "penalty";
            penalty.textContent = text;
            if (position && typeof position.x === 'number' && typeof position.y === 'number') {
                penalty.style.left = `${position.x * GRID_SIZE}px`;
                penalty.style.top = `${position.y * GRID_SIZE}px`;
            }
            document.querySelector(".game-container").appendChild(penalty);
            
            setTimeout(() => {
                penalty.remove();
            }, 1500);
        }
        
        // ç»“æŸæ¸¸æˆ
        function endGame() {
            gameOver = true;
            clearInterval(gameLoop);
            finalScoreEl.textContent = score;
            gameOverEl.style.display = "block";
            
            // æ’­æ”¾æ¸¸æˆç»“æŸéŸ³æ•ˆ
            playSound('gameover');
        }
        
        // ç»˜åˆ¶æ¸¸æˆ
        function drawGame() {
            ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            ctx.fillStyle = "#e7f5ff";
            ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            
            // ç»˜åˆ¶è›‡
            snake.forEach((segment, index) => {
                const x = segment.x * GRID_SIZE;
                const y = segment.y * GRID_SIZE;
                
                if (index === 0) {
                    // è›‡å¤´
                    ctx.fillStyle = "#2b8a3e";
                    ctx.beginPath();
                    ctx.roundRect(x, y, GRID_SIZE, GRID_SIZE, [10, 10, 5, 5]);
                    ctx.fill();
                } else {
                    // è›‡èº«
                    ctx.fillStyle = index % 2 === 0 ? "#51cf66" : "#40c057";
                    ctx.fillRect(x, y, GRID_SIZE, GRID_SIZE);
                    ctx.fillStyle = "#d3f9d8";
                    ctx.fillRect(x + 4, y + 4, GRID_SIZE - 8, GRID_SIZE - 8);
                }
            });
            
            // ç»˜åˆ¶é£Ÿç‰©
            food.forEach(f => {
                const x = f.x * GRID_SIZE;
                const y = f.y * GRID_SIZE;
                ctx.fillStyle = f.color;
                ctx.beginPath();
                ctx.arc(x + GRID_SIZE / 2, y + GRID_SIZE / 2, GRID_SIZE / 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = f.type === "correct" ? "#ff8787" : "#ffd43b";
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(x + GRID_SIZE / 2, y + GRID_SIZE / 2, GRID_SIZE / 2 + 2, 0, Math.PI * 2);
                ctx.stroke();
                ctx.fillStyle = "white";
                ctx.font = "bold 12px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(f.letter.toUpperCase(), x + GRID_SIZE / 2, y + GRID_SIZE / 2);
            });
        }
        
        // æ›´æ–°UI
        function updateUI() {
            if (currentWord) { // Check if currentWord is not null
                wordMeaningEl.textContent = currentWord.meaning; // This should be Chinese meaning now
            } else {
                // Handle case where currentWord might be temporarily null (e.g. during init before first selection)
                wordMeaningEl.textContent = "åŠ è½½ä¸­...";
            }
            scoreEl.textContent = score;
            comboEl.textContent = combo;
            maxComboEl.textContent = maxCombo;
        }
        
        // é”®ç›˜æ§åˆ¶
        document.addEventListener("keydown", e => {
            if (gamePaused && !gameOver && isWordCompletePopupActive) {
                // Handle Enter key for word complete popup only
                if (e.key === "Enter") {
                    continueGame();
                    return; // Prevent further processing
                }
                return; // Don't process other keys when paused
            }
            
            if (gameOver) {
                // Handle keys for game over state
                if (e.key === "Enter" || e.key === " ") {
                    initGame();
                }
                return; // Don't process other keys when game over
            }
            
            // Normal game controls when neither paused nor game over
            switch (e.key) {
                case "ArrowUp":
                    if (direction !== "DOWN") nextDirection = "UP";
                    break;
                case "ArrowDown":
                    if (direction !== "UP") nextDirection = "DOWN";
                    break;
                case "ArrowLeft":
                    if (direction !== "RIGHT") nextDirection = "LEFT";
                    break;
                case "ArrowRight":
                    if (direction !== "LEFT") nextDirection = "RIGHT";
                    break;
            }
        });
        
        // Add a direct Enter key handler to the continue button
        continueBtn.addEventListener("keydown", function(e) {
            if (e.key === "Enter") {
                e.preventDefault(); // Prevent default behavior
                continueGame();
            }
        });
        
        // é‡æ–°å¼€å§‹æŒ‰é’®
        restartBtn.addEventListener("click", initGame);
        
        // ç»§ç»­æ¸¸æˆæŒ‰é’®
        continueBtn.addEventListener("click", continueGame);
        
        // å‘éŸ³æŒ‰é’®
        const speakWordBtn = document.getElementById("speak-word-btn");
        speakWordBtn.addEventListener("click", () => {
            if (currentWord) {
                // é‡ç½®æŒ‰é’®åŠ¨ç”»
                speakWordBtn.style.animation = 'none';
                void speakWordBtn.offsetWidth; // è§¦å‘é‡ç»˜
                speakWordBtn.style.animation = null;
                
                // ä¸å†æ’­æ”¾é¢å¤–çš„éŸ³æ•ˆï¼Œç›´æ¥è¯»å•è¯
                speakWord(currentWord.word);
            }
        });
        
        // åœ¨å®Œæˆæ—¶å‘éŸ³å¯èƒ½ä¼šåœ¨ç§»åŠ¨è®¾å¤‡ä¸Šå¤±è´¥ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªå¯é çš„æ–¹æ³•
        function safelySpeak() {
            // çªå‡ºæ˜¾ç¤ºå¬è¯»éŸ³æŒ‰é’®
            setTimeout(() => {
                const speakBtn = document.getElementById("speak-word-btn");
                if (speakBtn) {
                    speakBtn.style.animation = "pulse 1.5s infinite";
                }
            }, 200);
            
            if (!isMobileDevice) {
                // æ¡Œé¢è®¾å¤‡ä¸Šå°è¯•è‡ªåŠ¨å‘éŸ³ï¼Œä½†å»¶è¿Ÿè¶³å¤Ÿæ—¶é—´è®©å®ŒæˆéŸ³æ•ˆå…ˆæ’­æ”¾å®Œ
                setTimeout(() => {
                    if (currentWord && !audioPlaying) {
                        speakWord(currentWord.word);
                    } else if (currentWord) {
                        // å¦‚æœéŸ³æ•ˆè¿˜åœ¨æ’­æ”¾ï¼Œå†å»¶è¿Ÿä¸€ç‚¹
                        setTimeout(() => speakWord(currentWord.word), 500);
                    }
                }, 1000);
            }
        }
        
        // ç‚¹å‡»æ˜¾ç¤ºæŒ‡å¼•æŒ‰é’®
        instructionsButton.addEventListener("click", () => {
            instructionsElement.style.display = "flex";
        });
        
        closeInstructions.addEventListener("click", () => {
            instructionsElement.style.display = "none";
        });
        
        // ç‚¹å‡»é®ç½©å±‚å…³é—­æŒ‡å¼•
        instructionsElement.addEventListener("click", (e) => {
            if (e.target === instructionsElement) {
                instructionsElement.style.display = "none";
            }
        });
        
        // Populate word group selector
        function populateWordGroupSelector() {
            const allOption = document.createElement("option");
            allOption.value = "all";
            allOption.textContent = "è¯·é€‰æ‹©éœ€è¦ç»ƒä¹ æ‹¼å†™çš„å•è¯ç»„";
            wordGroupSelect.appendChild(allOption);
            
            for (const groupKey in WORD_GROUPS) {
                if (Object.hasOwnProperty.call(WORD_GROUPS, groupKey)) {
                    const option = document.createElement("option");
                    option.value = groupKey;
                    option.textContent = `ç¬¬ ${groupKey} ç»„`;
                    wordGroupSelect.appendChild(option);
                }
            }
            
            wordGroupSelect.value = "all";
        }

        // Event listener for word group selection
        wordGroupSelect.addEventListener("change", (event) => {
            const selectedGroupKey = event.target.value;
            
            // If the game is over, fully reset with initGame
            // Otherwise just change the word group while preserving snake state
            if (gameOver) {
                if (selectedGroupKey === "all") {
                    // Create a combined word list from all groups
                    createCombinedWordList();
                    initGame();
                } else if (WORD_GROUPS[selectedGroupKey]) {
                    currentWordList = WORD_GROUPS[selectedGroupKey];
                    initGame(); // Complete reset when game is over
                }
            } else {
                if (selectedGroupKey === "all") {
                    createCombinedWordList();
                    changeWordGroup(selectedGroupKey);
                } else {
                    changeWordGroup(selectedGroupKey); // Preserve snake when game is ongoing
                }
            }
        });
        
        // Function to create a combined word list from all groups
        function createCombinedWordList() {
            currentWordList = [];
            for (const groupKey in WORD_GROUPS) {
                if (Object.hasOwnProperty.call(WORD_GROUPS, groupKey)) {
                    currentWordList = currentWordList.concat(WORD_GROUPS[groupKey]);
                }
            }
        }
        
        // è§¦æ‘¸æ§åˆ¶ï¼ˆç§»åŠ¨è®¾å¤‡ï¼‰
        let touchStartX = 0;
        let touchStartY = 0;
        
        canvas.addEventListener("touchstart", e => {
            if (gamePaused || gameOver) return;
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            e.preventDefault(); // Prevent scrolling when touching the canvas
        }, { passive: false });
        
        canvas.addEventListener("touchend", e => {
            if (gamePaused || gameOver) return;
            
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            
            // Minimum distance for swipe to be registered
            const minSwipeDistance = 30;
            
            if (Math.abs(deltaX) < minSwipeDistance && Math.abs(deltaY) < minSwipeDistance) {
                return; // Not enough movement to be considered a swipe
            }
            
            // Check if horizontal swipe is more significant than vertical
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                // Horizontal swipe
                if (deltaX > 0) {
                    // Swipe right
                    if (direction !== "LEFT") nextDirection = "RIGHT";
                } else {
                    // Swipe left
                    if (direction !== "RIGHT") nextDirection = "LEFT";
                }
            } else {
                // Vertical swipe
                if (deltaY > 0) {
                    // Swipe down
                    if (direction !== "UP") nextDirection = "DOWN";
                } else {
                    // Swipe up
                    if (direction !== "DOWN") nextDirection = "UP";
                }
            }
            
            e.preventDefault();
        }, { passive: false });
        
        // Prevent page scrolling when touching the canvas
        canvas.addEventListener("touchmove", e => {
            if (gamePaused || gameOver) return;
            e.preventDefault();
        }, { passive: false });
        
        // é€Ÿåº¦æ§åˆ¶é€»è¾‘
        const speedRange = document.getElementById('speed-range');
        const speedLabel = document.getElementById('speed-label');
        const speedMap = {
            100: 'é¾Ÿé€Ÿ',
            150: 'å¾ˆæ…¢',
            200: 'è¾ƒæ…¢',
            250: 'æ™®é€š',
            300: 'è¾ƒå¿«',
            350: 'å¾ˆå¿«',
            400: 'æå¿«'
        };
        function updateSpeedLabel(val) {
            // å–æœ€è¿‘çš„é€Ÿåº¦æ ‡ç­¾
            let closest = 100;
            for (let v of Object.keys(speedMap)) {
                if (Math.abs(val - v) < Math.abs(val - closest)) closest = v;
            }
            speedLabel.textContent = speedMap[closest] || val + 'ms';
        }
        speedRange.addEventListener('input', function() {
            // åè½¬ï¼šå·¦æœ€æ…¢å³æœ€å¿«
            gameSpeed = 500 - Number(speedRange.value);
            updateSpeedLabel(speedRange.value);
            if (gameLoop) {
                clearInterval(gameLoop);
                gameLoop = setInterval(gameStep, gameSpeed);
            }
        });
        // åˆå§‹åŒ–é€Ÿåº¦æ ‡ç­¾å’Œå®é™…é€Ÿåº¦
        updateSpeedLabel(speedRange.value);
        gameSpeed = 500 - Number(speedRange.value);
        
        // å¼€å§‹æ¸¸æˆ
        populateWordGroupSelector(); 
        const initialGroupKey = wordGroupSelect.value || "all";
        if (initialGroupKey === "all") {
            createCombinedWordList();
        } else if (WORD_GROUPS[initialGroupKey]) {
            currentWordList = WORD_GROUPS[initialGroupKey];
        } else if (Object.keys(WORD_GROUPS).length > 0) { 
            currentWordList = WORD_GROUPS[Object.keys(WORD_GROUPS)[0]];
            wordGroupSelect.value = Object.keys(WORD_GROUPS)[0]; 
        }
        initGame(); 
        canvas.focus(); // Initial focus on game start
    </script>
</body>
</html>